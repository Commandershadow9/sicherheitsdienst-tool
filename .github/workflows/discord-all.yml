name: Notify Discord

on:
  workflow_dispatch: {}              # manueller Test-Trigger (Run workflow)
  push:
    branches:
      - main                         # passe bei Bedarf an (oder nutze '**' fÃ¼r alle)
    tags:
      - 'v*'                         # Releases per Tag
  pull_request:
    types: [opened, synchronize, reopened, closed, ready_for_review, converted_to_draft]
  workflow_run:                      # CI-Ergebnisse melden
    workflows: [ "ci", "CI", "build", "test" ]   # muss den Workflow-Namen(en) entsprechen
    types: [completed]
  release:
    types: [published]

permissions:
  contents: read
  actions: read

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # Checkout nur wenn wir Dateien brauchen (push/release/dispatch)
      - name: Checkout
        if: ${{ github.event_name == 'push' || github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure jq, curl, python3 present
        run: sudo apt-get update && sudo apt-get install -y jq curl python3

      - name: Build Discord payload
        id: build
        shell: bash
        env:
          GH_EVENT_JSON: ${{ toJson(github.event) }}
        run: |
          set -euo pipefail

          esc_json () { python3 -c 'import sys, json; print(json.dumps(sys.stdin.read())[1:-1])'; }

          actor="${{ github.actor }}"
          repo="${{ github.repository }}"
          repo_url="https://github.com/${repo}"
          run_url="https://github.com/${repo}/actions/runs/${{ github.run_id }}"
          avatar="https://github.com/${actor}.png"
          ts="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          event="${{ github.event_name }}"

          TITLE=""
          DESC=""
          COLOR=5793266
          ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/info-24.svg"
          FIELDS="[]"

          if [ "$event" = "workflow_dispatch" ]; then
            TITLE="ðŸ”” Testbenachrichtigung"
            DESC="Manuell ausgelÃ¶st von **${actor}**\n${run_url}"
            COLOR=4437377
            ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/bell-24.svg"
            FIELDS=$(cat <<JSON
[
  { "name": "Repository", "value": "$(printf "%s" "$repo_url" | esc_json)" }
]
JSON
)
          elif [ "$event" = "push" ]; then
            ref="${GITHUB_REF_NAME:-unknown}"
            sha="${GITHUB_SHA:-}"
            short_sha="${sha:0:7}"
            before="$(echo "$GH_EVENT_JSON" | jq -r '.before // ""')"
            compare_url="${repo_url}/compare/${before}...${sha}"

            COMMITS_RAW="$(echo "$GH_EVENT_JSON" | jq -r '
              (.commits // [])[0:10][]?
              | "- **" + (.id[0:7]) + "**: " + ((.message // "") | gsub("\n"; " ")) + "  â€” _" + ((.author.username // .author.name) // "unknown") + "_"
            ')"
            [ -z "$COMMITS_RAW" ] && COMMITS_RAW="- (keine Commits Ã¼bermittelt)"
            COMMITS_ESC="$(printf "%s" "$COMMITS_RAW" | esc_json)"

            TITLE="ðŸ“¦ Push auf ${repo} â€” ${ref}"
            DESC="**Akteur:** ${actor}\n**Branch:** ${ref}\n**SHA:** \`${short_sha}\`\n**Vergleich:** ${compare_url}"
            COLOR=5814783
            ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/upload-24.svg"
            FIELDS=$(cat <<JSON
[
  { "name": "Commits", "value": "$COMMITS_ESC" },
  { "name": "Links", "value": "$(printf "â€¢ Repo: %s\nâ€¢ Actions: %s" "$repo_url" "$run_url" | esc_json)" }
]
JSON
)
          elif [ "$event" = "pull_request" ]; then
            pr_title='${{ github.event.pull_request.title }}'
            pr_num='${{ github.event.pull_request.number }}'
            pr_state='${{ github.event.pull_request.state }}'
            pr_merged='${{ github.event.pull_request.merged }}'
            pr_url='${{ github.event.pull_request.html_url }}'
            base='${{ github.event.pull_request.base.ref }}'
            head='${{ github.event.pull_request.head.ref }}'
            draft='${{ github.event.pull_request.draft }}'

            TITLE="ðŸ”€ PR #${pr_num}: ${pr_title}"
            status_emoji="ðŸŸ¢"
            [ "$pr_state" != "open" ] && status_emoji="ðŸŸ¡"
            [ "${pr_merged}" = "true" ] && status_emoji="ðŸŸ£"
            [ "${draft}" = "true" ] && status_emoji="âšª"
            DESC="${status_emoji} **Status:** ${pr_state}  |  **Merged:** ${pr_merged}\n**Akteur:** ${actor}\n${pr_url}"
            COLOR=9055202
            ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/git-pull-request-24.svg"
            FIELDS=$(cat <<JSON
[
  { "name": "Basis â†’ Head", "value": "$(printf "\`%s\` â†’ \`%s\`" "$base" "$head" | esc_json)" },
  { "name": "Repository", "value": "$(printf "%s" "$repo_url" | esc_json)" }
]
JSON
)
          elif [ "$event" = "workflow_run" ]; then
            name='${{ github.event.workflow_run.name }}'
            conc='${{ github.event.workflow_run.conclusion }}'
            TITLE="ðŸ§ª CI: ${name}"
            case "$conc" in
              success) COLOR=4437377; status="âœ… Erfolg";;
              failure) COLOR=13631488; status="âŒ Fehlgeschlagen";;
              cancelled) COLOR=14540253; status="â¹ï¸ Abgebrochen";;
              skipped) COLOR=15132390; status="â­ï¸ Ãœbersprungen";;
              *) COLOR=8421504; status="â„¹ï¸ ${conc}";;
            esac
            DESC="**Akteur:** ${actor}\n**Ergebnis:** ${status}\n${run_url}"
            ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/checklist-24.svg"
            FIELDS=$(cat <<JSON
[
  { "name": "Workflow", "value": "$(printf "%s" "$name" | esc_json)" },
  { "name": "Repository", "value": "$(printf "%s" "$repo_url" | esc_json)" }
]
JSON
)
          elif [ "$event" = "release" ]; then
            tag='${{ github.event.release.tag_name }}'
            rname='${{ github.event.release.name }}'
            rurl='${{ github.event.release.html_url }}'
            [ -z "$rurl" ] && rurl="${repo_url}/releases/tag/${tag}"

            TITLE="ðŸ·ï¸ Release ${tag}"
            [ -n "$rname" ] && TITLE="ðŸ·ï¸ ${rname} (${tag})"
            DESC="**Repository:** ${repo}\n**Akteur:** ${actor}\n**Release:** ${rurl}"
            COLOR=5793266
            ICON="https://raw.githubusercontent.com/primer/octicons/main/icons/tag-24.svg"

            version="${tag#v}"
            CHANGELOG_SECTION=""
            if [ -f CHANGELOG.md ]; then
              CHANGELOG_SECTION="$(awk -v ver="$version" '
                BEGIN{found=0}
                tolower($0) ~ "^##[[:space:]]*\\[?v?" tolower(ver) "\\]?" { if(!found){found=1; next} }
                found && /^##[[:space:]]*\[?v?[0-9]/ {exit}
                found {print}
              ' CHANGELOG.md)"
            fi
            [ -z "$CHANGELOG_SECTION" ] && CHANGELOG_SECTION="(Kein spezifischer Changelog-Eintrag fÃ¼r ${tag} gefunden.)"

            CLEAN_SECTION="$(printf '%s' "$CHANGELOG_SECTION")"
            if [ "${#CLEAN_SECTION}" -gt 1000 ]; then
              CLEAN_SECTION="${CLEAN_SECTION:0:1000}\nâ€¦ (gekÃ¼rzt)"
            fi

            FIELDS=$(cat <<JSON
[
  { "name": "Ã„nderungen (CHANGELOG)", "value": "$(printf "%s" "$CLEAN_SECTION" | esc_json)" },
  { "name": "Links", "value": "$(printf "â€¢ Repo: %s\nâ€¢ Actions: %s\nâ€¢ Tag: %s" "$repo_url" "$run_url" "$rurl" | esc_json)" }
]
JSON
)
          fi

          title_json="$(printf "%s" "$TITLE" | esc_json)"
          desc_json="$(printf "%s" "$DESC" | esc_json)"

          cat > payload.json <<JSON
{
  "username": "GitHub Â· ${repo}",
  "avatar_url": "${avatar}",
  "embeds": [
    {
      "title": "${title_json}",
      "description": "${desc_json}",
      "color": ${COLOR},
      "timestamp": "${ts}",
      "thumbnail": { "url": "${ICON}" },
      "fields": ${FIELDS},
      "footer": { "text": "Automatische Benachrichtigung â€¢ $(date -u +%Y-%m-%d)" }
    }
  ]
}
JSON

          # als Ausgabe (base64) fÃ¼r den nÃ¤chsten Step
          base64 -w0 < payload.json > payload.b64 || base64 < payload.json > payload.b64
          echo "payload=$(cat payload.b64)" >> "$GITHUB_OUTPUT"

      - name: Send to Discord (with retry)
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          WEBHOOK_CI: ${{ secrets.DISCORD_WEBHOOK_CI }}
        shell: bash
        run: |
          set -euo pipefail
          # WÃ¤hle Kanal: fÃ¼r workflow_run (CI-Status) bevorzugt CI-Hook, andernfalls Default
          URL="$WEBHOOK"
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ -n "${WEBHOOK_CI:-}" ]; then
            URL="$WEBHOOK_CI"
          fi
          test -n "${URL:-}" || { echo "::error::Secret DISCORD_WEBHOOK (oder _CI) fehlt"; exit 1; }
          # base64 decode (Linux/macOS compatible)
          echo "${{ steps.build.outputs.payload }}" | base64 -d > payload.json || echo "${{ steps.build.outputs.payload }}" | base64 -D > payload.json

          # bis zu 5 Versuche (z.B. bei 429 Rate Limit)
          for i in 1 2 3 4 5; do
            http_code=$(curl -sS -H "Content-Type: application/json" -d @payload.json "$URL" -o resp.txt -w "%{http_code}" || echo "000")
            echo "Discord HTTP: $http_code (try $i)"
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "OK"; break
            fi
            echo "Antwort:"
            cat resp.txt || true
            sleep $((i*2))
          done

          # finaler Check
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "::error::Discord-Request fehlgeschlagen (HTTP $http_code)"
            exit 1
          fi
