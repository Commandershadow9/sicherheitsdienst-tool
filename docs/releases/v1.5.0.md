# Release v1.5.0 - Abwesenheiten Phase 2 & Testing ğŸš€

**Release-Datum**: 2025-10-03
**Typ**: Feature Release
**Fokus**: Abwesenheits-Management erweitert, Dokument-Uploads, Benachrichtigungen & Test-Coverage

---

## ğŸ¯ Ãœberblick

Version 1.5.0 erweitert das Abwesenheits-Management um wichtige Features fÃ¼r den produktiven Einsatz:
- **Dokument-Uploads** fÃ¼r Krankschreibungen und Atteste
- **Automatische Benachrichtigungen** bei Genehmigung/Ablehnung
- **Erweiterte Test-Coverage** (Frontend & Backend)

---

## âœ¨ Neue Features

### Abwesenheiten: Dokument-/Attest-Uploads

**Backend:**
- âœ… Neues Datenmodell: `AbsenceDocument` (Migration: `20251003194454_add_absence_documents`)
- âœ… API-Endpoints:
  - `POST /api/absences/:id/documents` - Upload von Dokumenten (PDF, JPG, PNG bis 50MB)
  - `GET /api/absences/:id/documents/:documentId/download` - Dokument-Download
  - `DELETE /api/absences/:id/documents/:documentId` - Dokument lÃ¶schen
- âœ… Speicherung: `/srv/documents/absences/{userId}/` (isoliert von Employee-Dokumenten)
- âœ… Audit-Logging: `ABSENCE.DOCUMENT.UPLOAD/DOWNLOAD/DELETE`
- âœ… RBAC: Zugriff nur fÃ¼r berechtigte User (Self oder ADMIN/MANAGER)

**Frontend:**
- âœ… Upload-Button direkt in Abwesenheiten-Tabelle (Tab "Abwesenheiten" im Profil)
- âœ… Dokumenten-Liste mit Vorschau (ğŸ“ Icon pro Dokument)
- âœ… Vorschau-Funktion: Ã–ffnet PDF/Bilder in neuem Browser-Tab
- âœ… File-Input mit Accept-Filter: `.pdf,.jpg,.jpeg,.png`

### Abwesenheiten-Benachrichtigungen

**Templates:**
- âœ… `absence-approved` (E-Mail & Push)
- âœ… `absence-rejected` (E-Mail & Push)
- âœ… `absence-cancelled` (E-Mail & Push)

**FunktionalitÃ¤t:**
- âœ… Automatischer Versand bei `approve`, `reject`, `cancel`
- âœ… Respektiert User-Einstellungen (`emailOptIn`, `pushOptIn`)
- âœ… Feature-Flags:
  - `EMAIL_NOTIFY_ABSENCES` (default: enabled)
  - `PUSH_NOTIFY_ABSENCES` (default: enabled)
- âœ… EnthÃ¤lt: Typ, Zeitraum, Decision-Note

### Testing-Infrastruktur

**Frontend (Vitest):**
- âœ… Vitest Setup mit `jsdom` Environment
- âœ… `@testing-library/react` + `@testing-library/jest-dom`
- âœ… Test-Setup: `src/test/setup.ts` mit localStorage-Mock
- âœ… **AuthProvider Tests** (`AuthProvider.test.tsx`):
  - Login erfolgreich
  - Logout korrekt
  - Hydration aus localStorage
  - User-Fetch wenn nur Tokens vorhanden
  - Token-Refresh (Mocking)
  - Initial-Zustand ohne Authentication
- âœ… **Bestehende Tests**:
  - `interceptors.test.ts` (3 Tests)
  - `listParams.test.ts` (3 Tests)
  - `absences/utils.test.ts` (4 Tests)
- **Gesamt: 16 Tests passing** âœ…

**Backend (Jest):**
- âœ… Integrationstest fÃ¼r Absence-Konflikte (`absence.conflicts.test.ts`)
  - Konflikte bei Schicht-Ãœberschneidung
  - Keine Konflikte bei separaten ZeitrÃ¤umen
  - Manager kann Abwesenheit mit Konflikten erstellen
  - Sickness-Absence wird trotz Konflikt auto-approved

---

## ğŸ”§ Verbesserungen

### Dokumentenspeicherung
- âœ… `documentStorage.ts` unterstÃ¼tzt nun optionale **Unterordner** (`subFolder` Parameter)
- âœ… Pfade: `absences/{userId}/{uuid}.pdf` vs. `{userId}/{uuid}.pdf` (Employee-Docs)
- âœ… Konsistente Upload-Logik fÃ¼r beide Dokumenten-Typen

### Notification-System
- âœ… Neue Kategorie `absence` in `NotificationTemplateMeta`
- âœ… Templates werden in Event-System publiziert
- âœ… Konsistente Variable-Namen: `userName`, `type`, `startsAt`, `endsAt`, `decisionNote`

### Konflikt-Handling
- âœ… Backend liefert bereits bei `POST /api/absences` Konflikt-Informationen
- âœ… Konflikte werden in Response als Array zurÃ¼ckgegeben: `{ success: true, data, conflicts: [...] }`

---

## ğŸ“Š GeÃ¤nderte Dateien

### Backend
- `prisma/schema.prisma` - `AbsenceDocument` Model + Relation
- `src/controllers/absenceController.ts` - Upload/Download/Delete Handler + Notifications
- `src/routes/absenceRoutes.ts` - Neue Routen fÃ¼r Dokumente
- `src/utils/documentStorage.ts` - Unterordner-Support
- `src/config/notificationTemplates.ts` - Absence-Templates
- `src/__tests__/absence.conflicts.test.ts` - Neuer Integrationstest

### Frontend
- `package.json` - Testing-Dependencies (`vitest`, `@testing-library/react`, `jsdom`)
- `vite.config.ts` - Vitest-Konfiguration (jsdom, globals, setupFiles)
- `src/test/setup.ts` - Test-Setup mit localStorage-Mock
- `src/features/auth/AuthProvider.test.tsx` - AuthProvider Tests
- `src/features/users/UserProfile.tsx`:
  - Upload-Handler fÃ¼r Absence-Dokumente
  - Preview-Handler fÃ¼r Absence-Dokumente
  - Neue Spalte "Dokumente" in Absence-Tabelle

---

## ğŸš€ Migration & Upgrade

### Von v1.4.x zu v1.5.0

#### 1. Prisma Migration
```bash
docker compose exec api npx prisma migrate deploy
```

Migration: `20251003194454_add_absence_documents`
- Erstellt Tabelle `absence_documents`
- FÃ¼gt Relation zu `absences` hinzu (Cascade Delete)

#### 2. Container neu starten
```bash
docker compose restart api
```

#### 3. Frontend-Dependencies (optional, wenn lokal entwickelt)
```bash
cd frontend
npm install
```

Neue Dependencies:
- `@testing-library/react@^16.3.0`
- `@testing-library/jest-dom@^6.9.1`
- `@testing-library/user-event@^14.6.1`
- `jsdom@^27.0.0`

#### 4. Tests ausfÃ¼hren (optional)
```bash
# Frontend
cd frontend
npm test

# Backend
cd backend
npm test
```

---

## âš ï¸ Breaking Changes

Keine Breaking Changes fÃ¼r API oder Frontend.

**Hinweise:**
- Neue ENV-Variablen sind optional:
  - `EMAIL_NOTIFY_ABSENCES` (default: enabled)
  - `PUSH_NOTIFY_ABSENCES` (default: enabled)
- Dokumente fÃ¼r Absences benÃ¶tigen gleiche Storage-Struktur wie Employee-Docs (`/srv/documents`)

---

## ğŸ§ª Testing

### Frontend Tests
```bash
npm test
```

**Ergebnis:**
```
âœ“ src/features/auth/AuthProvider.test.tsx (6 tests)
âœ“ src/features/auth/interceptors.test.ts (3 tests)
âœ“ src/features/common/listParams.test.ts (3 tests)
âœ“ src/features/absences/utils.test.ts (4 tests)

Test Files  4 passed (4)
Tests       16 passed (16)
```

### Backend Tests
```bash
npm test absence.conflicts.test.ts
```

**Abgedeckte Szenarien:**
- Konflikte bei Schicht-Ãœberschneidung erkennen
- Keine Konflikte bei separaten ZeitrÃ¤umen
- Manager-Rechte fÃ¼r Abwesenheit mit Konflikten
- Auto-Approval fÃ¼r Sickness trotz Konflikt

---

## ğŸ“ Dokumentation

### Aktualisiert
- `CHANGELOG.md` - v1.5.0 Eintrag
- `docs/TODO.md` - P1-Tasks als erledigt markiert
- `docs/releases/v1.5.0.md` - Diese Release Notes

### Relevant
- `docs/planning/absences.md` - Abwesenheiten-Planung
- `docs/planning/employee-profile.md` - Employee-Profil (Dokumente)

---

## ğŸ”œ NÃ¤chste Schritte (v1.6.0+)

### P2-Features (Mittelfristig)
- [ ] **Absences ICS & Kalender**: ICS-Export fÃ¼r Abwesenheiten (Pro Nutzer/Team)
- [ ] **Grafana/Alerts**: Panels fÃ¼r Absence-Queues, Login-Error-Rate
- [ ] **Storage Evaluierung**: S3/MinIO fÃ¼r Dokument-Uploads

### DSGVO-Kritisch (Weiterhin offen)
- [ ] **HTTPS mit Let's Encrypt** (benÃ¶tigt Domain-Name)
- [ ] **AVV mit IP-Projects GmbH & Co. KG** abschlieÃŸen
- [ ] **LÃ¶schkonzept** implementieren (Auto-LÃ¶schung nach 6 Monaten)

---

## ğŸ“Š Statistiken

- **11 Dateien geÃ¤ndert**
- **+1309 Zeilen** hinzugefÃ¼gt
- **-11 Zeilen** gelÃ¶scht
- **3 neue Test-Dateien**
- **1 neue Migration**

---

## ğŸ™ Danke

Besonderer Dank an alle Tester!

---

**GitHub Release**: https://github.com/Commandershadow9/sicherheitsdienst-tool/releases/tag/v1.5.0

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
