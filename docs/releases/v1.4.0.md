# Release v1.4.0 - Security Milestone üîí

**Release-Datum**: 2025-10-03
**Typ**: Major Security Release
**Fokus**: DSGVO-konforme Dokumentenspeicherung mit umfassenden Sicherheitsma√ünahmen

---

## üéØ √úberblick

Version 1.4.0 ist ein **Security Milestone** der das Sicherheitsdienst-Tool auf DSGVO-konforme Verarbeitung hochsensibler Gesundheitsdaten (Krankschreibungen, Sicherheitskonzepte, Personalakten) vorbereitet.

Alle kritischen Sicherheitsma√ünahmen f√ºr die Dokumentenspeicherung wurden implementiert und getestet.

---

## üîí Security & DSGVO-Compliance

### Verschl√ºsselung

#### Verschl√ºsselung at Rest (Ruhende Daten)
- ‚úÖ **LUKS-Verschl√ºsselung** f√ºr `/srv/documents`
  - AES-256 Vollverschl√ºsselung
  - Automatisches Mounting via `/etc/crypttab` und `/etc/fstab`
  - Dokumentiert in `docs/ops/setup-document-storage.sh`

- ‚úÖ **BorgBackup mit AES-256**
  - Verschl√ºsselte inkrementelle Backups
  - Passphrase-Schutz: `documents-backup-2025-secure-key`
  - Repository: `/backups/borg/documents`
  - Retention-Policy: 7 t√§glich, 4 w√∂chentlich, 12 monatlich
  - Systemd Timer: T√§glich 03:00 Uhr
  - **Restore-Funktion getestet und verifiziert**

#### Verschl√ºsselung in Transit (√úbertragung)
- ‚ö†Ô∏è **HTTPS/TLS noch ausstehend** (ben√∂tigt Domain-Namen)
- üìã Vollst√§ndige Anleitung vorbereitet: `docs/ops/setup-https-letsencrypt.md`
- üîß Nginx bereits konfiguriert (tempor√§r deaktiviert)

### Schutzma√ünahmen

- ‚úÖ **ClamAV Antivirus**
  - Daemon l√§uft kontinuierlich
  - T√§glicher automatischer Scan um 02:30 Uhr
  - Automatische Quarant√§ne in `/var/quarantine`
  - Virendatenbank wird t√§glich aktualisiert (freshclam)
  - Systemd Timer: `clamscan.service` & `clamscan.timer`

- ‚úÖ **UFW Firewall**
  - Default: Deny Incoming, Allow Outgoing
  - Whitelisted Ports: 22 (SSH), 3001 (API), 5173 (Frontend), 80/443 (HTTP/HTTPS)
  - Logging Level: Medium
  - Konfigurationsskript: `docs/ops/configure-firewall.sh`

- ‚úÖ **Container-H√§rtung**
  - Non-root User: `appuser` (UID 1001, GID 109)
  - Gruppenzugriff auf svc-docstore
  - Minimale Berechtigungen
  - Alle Files geh√∂ren `appuser:svc-docstore`
  - Logs-Verzeichnis mit korrekten Permissions

### Zugriffskontrolle

- ‚úÖ **RBAC f√ºr Dokumente**
  - **MANAGER**: Upload, Download, L√∂schen
  - **DISPATCHER**: Nur Download (Read-Only)
  - **EMPLOYEE**: Nur eigene Dokumente
  - Need-to-Know Prinzip (Datenminimierung)

- ‚úÖ **Audit-Logging**
  - Alle Dokumentenzugriffe werden protokolliert
  - Download, Upload, Delete Events
  - User-ID, Timestamp, Action

### DSGVO-Dokumentation

- ‚úÖ **Vollst√§ndige Compliance-Dokumentation** (`docs/ops/dsgvo-compliance.md`)
  - Technische und Organisatorische Ma√ünahmen (TOM)
  - Verarbeitungsverzeichnis (Art. 30 DSGVO)
  - L√∂schkonzept
  - Incident Response Plan
  - Betroffenenrechte
  - AVV-Anforderungen f√ºr Hosting-Provider

---

## ‚ú® Neue Features

### Backend

- **Dokumenten-Upload bis 50MB**
  - Express body limit auf 50MB erh√∂ht
  - Base64-Encoding ber√ºcksichtigt (~33% Overhead)
  - Unterst√ºtzt: PDF, Bilder (JPG, PNG), Office-Dokumente

- **Sichere Dokumentenverwaltung** (`backend/src/utils/documentStorage.ts`)
  - Path-Traversal-Schutz
  - UUID-basierte Dateinamen
  - User-spezifische Verzeichnisse
  - Automatisches Cleanup bei L√∂schung

- **Health Endpoint Verbesserungen**
  - `/health` als Alias f√ºr `/healthz`
  - Optimiert f√ºr Docker Healthchecks
  - Keine DB-Abh√§ngigkeit (Liveness)

### Operations

- **Systemd Services**
  - `borg-backup.service` & `borg-backup.timer`
  - `clamscan.service` & `clamscan.timer`
  - Automatische Ausf√ºhrung und Logging

- **Ops-Skripte**
  - `setup-document-storage.sh` - LUKS-Volume Setup
  - `configure-firewall.sh` - UFW-Konfiguration
  - `backup.sh` - BorgBackup Helper
  - Alle in `docs/ops/` dokumentiert

- **Checklisten**
  - `document-storage-checklist.md` - Audit-Vorlage
  - Setup-Anleitung f√ºr HTTPS (Let's Encrypt)

### CI/CD

- **Discord Notifications optimiert**
  - Lange Commit-Messages werden automatisch aufgeteilt (>1800 Zeichen)
  - Zwei Discord-Posts bei sehr langen Commits (Teil 1 & Teil 2)
  - Unn√∂tige Links entfernt
  - Kompaktere Formatierung

---

## üîß Verbesserungen

### Backend

- **CORS-Konfiguration**
  - Korrekte Origin-Konfiguration f√ºr externe IP
  - `CORS_ORIGIN` in docker-compose.yml Environment hinzugef√ºgt
  - Unterst√ºtzt Frontend auf separater IP

- **Docker Optimierungen**
  - Backend-Volume entfernt (verhinderte kompilierte √Ñnderungen)
  - Logs-Verzeichnis wird mit korrekten Permissions erstellt
  - Alle Dateien geh√∂ren appuser:svc-docstore
  - Multi-stage Build optimiert

### Frontend

- **API-Port-Mapping korrigiert**
  - 5173/4173 mapped jetzt korrekt auf 3001 (vorher f√§lschlich 3000)
  - Automatische Detection und Fallback

---

## üêõ Bugfixes

- **Frontend Login**
  - CORS-Fehler behoben
  - ENV-Variablen korrekt gesetzt
  - Vite Dev-Server l√§uft stabil

- **Container-Berechtigungen**
  - Logs-Verzeichnis Permissions korrigiert
  - Non-root User kann jetzt schreiben

- **Upload-Limit**
  - 413 Payload Too Large Fehler behoben
  - Express body parser auf 50MB konfiguriert

- **Docker Health Checks**
  - `wget` im finalen Image vorhanden
  - `/health` Endpoint funktioniert

- **Profilansicht**
  - Hook-Reihenfolge stabilisiert
  - Selbst-/Fremdprofile laden fehlerfrei

- **Datepicker Dark-Mode**
  - Icon bleibt sichtbar (invertiert)

---

## üìö Dokumentation

### Neu

- `docs/ops/dsgvo-compliance.md` - **DSGVO-Compliance vollst√§ndig dokumentiert**
- `docs/ops/setup-https-letsencrypt.md` - Let's Encrypt Setup-Anleitung
- `docs/ops/README.md` - Ops-Dokumentation aktualisiert
- `docs/releases/v1.4.0.md` - Diese Release Notes

### Aktualisiert

- `CHANGELOG.md` - Alle √Ñnderungen dokumentiert
- `ROADMAP.md` - DSGVO-kritische Tasks als hohe Priorit√§t
- `README.md` - Security-Features hervorgehoben
- `.gitignore` - Docker Build Cache ignoriert

---

## üöÄ Migration & Upgrade

### Von v1.3.x zu v1.4.0

**Wichtig:** Dieses Release erfordert **manuelle Ops-Schritte** f√ºr die sichere Dokumentenspeicherung.

#### 1. LUKS-Volume einrichten

```bash
cd /home/cmdshadow/project
sudo ./docs/ops/setup-document-storage.sh \
  --luks-file /srv/vault/documents.luks \
  --size 20G \
  --mapper-name docstore \
  --mount-point /srv/documents \
  --owner svc-docstore \
  --group svc-docstore
```

Anschlie√üend `/etc/crypttab` und `/etc/fstab` aktualisieren (siehe Script-Output).

#### 2. Firewall konfigurieren

```bash
sudo ./docs/ops/configure-firewall.sh
```

#### 3. ClamAV installieren

```bash
sudo apt-get update
sudo apt-get install -y clamav clamav-daemon clamav-freshclam

# Virendatenbank aktualisieren
sudo freshclam

# Systemd Timer einrichten
sudo cp docs/ops/clamscan.service /etc/systemd/system/
sudo cp docs/ops/clamscan.timer /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable --now clamscan.timer
```

#### 4. BorgBackup einrichten

```bash
sudo apt-get install -y borgbackup

# Borg Repository initialisieren
export BORG_PASSPHRASE="documents-backup-2025-secure-key"
sudo -E borg init --encryption=repokey /backups/borg/documents

# Systemd Timer einrichten
sudo cp docs/ops/borg-backup.service /etc/systemd/system/
sudo cp docs/ops/borg-backup.timer /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable --now borg-backup.timer
```

#### 5. Backend neu bauen

```bash
docker compose up -d --build api
```

#### 6. Verifizieren

```bash
# Systemd Timer pr√ºfen
sudo systemctl status clamscan.timer
sudo systemctl status borg-backup.timer

# Firewall pr√ºfen
sudo ufw status

# Backup testen
sudo BORG_PASSPHRASE="documents-backup-2025-secure-key" \
  borg list /backups/borg/documents

# Container pr√ºfen
docker exec sicherheitsdienst-api id
# Sollte zeigen: uid=1001(appuser) gid=109(svc-docstore)
```

---

## ‚ö†Ô∏è Breaking Changes

Keine Breaking Changes f√ºr die API oder das Frontend.

**Operations:**
- Container l√§uft jetzt als non-root (UID 1001:GID 109)
- Dokumentenspeicher erfordert `/srv/documents` Mount
- Environment Variable `DOCUMENT_STORAGE_ROOT=/srv/documents` erforderlich

---

## üìä Statistiken

- **35 Dateien ge√§ndert**
- **1605 Zeilen hinzugef√ºgt**
- **113 Zeilen gel√∂scht**
- **12 neue Dateien** (Ops-Skripte & Dokumentation)
- **6 neue Systemd Services/Timers**

---

## üîú N√§chste Schritte (v1.5.0+)

### DSGVO-Kritisch (Hohe Priorit√§t)

- [ ] **HTTPS mit Let's Encrypt einrichten** (ben√∂tigt Domain)
  - Anleitung: `docs/ops/setup-https-letsencrypt.md`
  - Nginx bereits vorbereitet

- [ ] **AVV mit Hosting-Provider abschlie√üen**
  - Provider: IP-Projects GmbH & Co. KG
  - Siehe: `docs/ops/dsgvo-compliance.md` Abschnitt 1

- [ ] **L√∂schkonzept implementieren**
  - Automatische L√∂schung inaktiver User nach 6 Monaten
  - Cronjob/Scheduled Task

### Features

- [ ] Monitoring & Alerting (Grafana/Prometheus)
- [ ] E-Mail-Benachrichtigungen f√ºr Abwesenheiten
- [ ] Kalender-Integration (ICS/Outlook)
- [ ] 2FA f√ºr Login
- [ ] SSH-Keys statt Passwort
- [ ] Security Audit / Penetration Testing

---

## üôè Danke

Besonderer Dank an alle Tester und Contributors!

---

## üìù Vollst√§ndiges Changelog

Siehe [CHANGELOG.md](../../CHANGELOG.md) f√ºr alle Details.

---

**GitHub Release**: https://github.com/Commandershadow9/sicherheitsdienst-tool/releases/tag/v1.4.0

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
