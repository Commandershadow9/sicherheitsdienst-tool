# Release v1.3.0 – Abwesenheiten & Profilpflege

Datum: 2025-10-03

## Highlights

- Abwesenheitsmodul (Backend + Frontend)
  - Neue Endpunkte `GET/POST /api/absences`, `POST /api/absences/:id/approve|reject|cancel` inklusive RBAC (Self-Service für Mitarbeitende, Entscheidungen durch Admin/Manager).
  - Statusfilter (`status`, `type`, `from`, `to`, `userId`), CSV/XLSX-Export und Konfliktwarnungen bei überlappenden Schichtzuweisungen.
  - Audit-Events für Create/Approve/Reject/Cancel, automatische Genehmigung für Krankmeldungen.
- Überarbeitetes Mitarbeiterprofil
  - Zeitkennzahlen (letzte 7/30 Tage, YTD), Qualifikationen, Dokumente und Vorschau der nächsten genehmigten Abwesenheiten.
  - Self-Service für Adresse/Telefon; Manager/Admin verwalten Beschäftigungsdaten, Qualifikationen, Dokumente.
- Auth & Login
  - Login liefert jetzt Access- und Refresh-Token; Interceptor persistiert Tokens in `localStorage` und erneuert sie 30 s vor Ablauf.
  - Login-UI blockiert Rate-Limits mit Countdown, zeigt Netzwerkfehler und Logout funktioniert ohne Hard-Reload.
- Systemdashboard & Monitoring
  - `/system` visualisiert `/api/stats` (Notification-Queues, Audit-Trail, Event-Loop, Feature-Flags) und ersetzt viele schnelle Grafana-Blicke.
  - metrics-smoke Workflow liefert klarere Artefakte; Monitoring-Dokus (Ports, synthetische Checks) sind aktualisiert.

## API-Änderungen

- Neue Ressource `Absence` (Prisma-Modell + Migration) mit Typen `VACATION`, `SICKNESS`, `SPECIAL_LEAVE`, `UNPAID` und Status `REQUESTED|APPROVED|REJECTED|CANCELLED`.
- Login-Response enthält `accessToken`, `refreshToken` sowie das bestehende Feld `token` (Alias für das Access-Token).
- Mitarbeiterprofil-Endpunkte liefern zusätzliche Felder (`address`, `employment*`, `timeSummary`, `upcomingAbsences`).
- System-Stats (`GET /api/stats`) erweitert um Notification-/Queue-Daten, Audit-Kennzahlen und Event-Loop-Metriken (Front-End nutzt sie im Dashboard).

## Frontend

- Neuer Navigationspunkt „Abwesenheiten“ für alle Rollen (EMPLOYEE sieht nur eigene Einträge).
- Profilansicht (`/users/:id/profile`) konsolidiert Stammdaten, Abwesenheiten und dokumentiert Qualifikationen/Dokumente.
- Axios-Client erkennt lokale Vite-Ports (`5173`/`4173`) und mappt automatisch auf `:3000`; Fallback auf aktuelles Origin, falls `VITE_API_BASE_URL` fehlt.
- Auth-Provider persistiert Tokens, führt Refresh-Läufe sequentiell aus und räumt `localStorage` bei Fehlern.

## Migration / ENV

- Prisma-Migration ausführen (`npx prisma migrate deploy`) – neues `Absence`-Modell plus Indizes.
- Keine neuen Pflicht-ENV-Variablen. Bestehende Secrets (`JWT_SECRET`, `REFRESH_SECRET`) weiterhin erforderlich.

## Tests / QA

- Backend: Jest-Suite (Absence-Controller, Profile-Updates) + Prisma-Migrationen durchlaufen.
- Frontend: Vitest/Playwright frisch ausführen; Absence-Flow (Antrag → Genehmigung → Storno) und Profil-Bearbeitung manuell verifizieren.
- metrics-smoke Workflow beobachten (Artefakte: Stats-Dump, Prometheus Targets) – Alerts sollten weiterhin grün laufen.

## Follow-up

- Phase 2: Dokument-/Attest-Uploads (S3/MinIO), Kalender-Overlay und Notifications für Absence-Entscheidungen.
- ICS-Export für Abwesenheiten sowie Grafana-Panels/Alerts auf Absence- und Login-Fehlerraten.
- Playwright-Szenarien für Absence-Flow & Profilpflege ergänzen; Vitest für Auth-Refresh & Konflikt-Helper aufbauen.

