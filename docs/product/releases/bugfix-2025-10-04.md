# Bugfix Release ‚Äì 2025-10-04

**Status**: Deployed
**Version**: v1.6.0 + Hotfixes
**Typ**: Critical Bugfixes

## Zusammenfassung

Nach dem v1.6.0 Release wurden mehrere kritische Bugs identifiziert und behoben, die das Laden der Abwesenheiten-Liste und die Funktionalit√§t der Detailansicht verhinderten.

## Behobene Bugs

### üî¥ Critical: Express Routen-Reihenfolge Bug
**Problem**: `/api/absences/:id/preview-warnings` gab 404 zur√ºck

**Root Cause**: In `backend/src/routes/absenceRoutes.ts` wurde die generische Route `/:id` VOR den spezifischen Routen wie `/:id/preview-warnings` definiert. Express.js matched Routen in Definitionsreihenfolge, daher wurde `preview-warnings` als ID-Parameter interpretiert.

**Fix**:
```typescript
// VORHER (falsch):
router.get('/:id', ...)
router.get('/:id/preview-warnings', ...) // ‚Üí nie erreicht!

// NACHHER (korrekt):
router.get('/:id/preview-warnings', ...) // Spezifisch ZUERST
router.get('/:id/replacement-candidates', ...)
router.get('/:id', ...) // Generisch ZULETZT
```

**Dateien ge√§ndert**:
- `backend/src/routes/absenceRoutes.ts`

**Auswirkung**: Kapazit√§tswarnungen beim Genehmigen funktionieren jetzt korrekt.

---

### üî¥ Critical: Query Validation Fehler
**Problem**: `/api/absences?page=1&sortDir=asc` gab 400 Bad Request zur√ºck

**Root Cause**: Frontend sendet `sortBy` und `sortDir` Parameter, aber die Zod-Validierung in `listAbsenceQuerySchema` erlaubte diese nicht.

**Fix**:
```typescript
// backend/src/validations/absenceValidation.ts
export const listAbsenceQuerySchema = z.object({
  query: z.object({
    page: z.string().regex(/^\d+$/).optional(),
    pageSize: z.string().regex(/^\d+$/).optional(),
    sortBy: z.string().optional(),           // ‚Üê NEU
    sortDir: z.enum(['asc', 'desc']).optional(), // ‚Üê NEU
    type: z.nativeEnum(AbsenceType).optional(),
    status: z.nativeEnum(AbsenceStatus).optional(),
    // ...
  })
})
```

**Auswirkung**: Abwesenheiten-Liste l√§dt jetzt korrekt mit Sortierung.

---

### üü° High: 401 Unauthorized bei Mitarbeiter-Dropdown
**Problem**: Console-Error "GET /api/users 401 Unauthorized" beim Laden der Abwesenheiten-Seite

**Root Cause**: React Query versuchte User-Liste zu laden bevor Authentifizierung abgeschlossen war.

**Fix**:
```typescript
// frontend/src/features/absences/AbsencesList.tsx
const { data: usersData } = useQuery({
  queryKey: ['users', 'for-absences'],
  queryFn: async () => { ... },
  enabled: isManager && !!user, // ‚Üê !!user hinzugef√ºgt
  placeholderData: [] as MinimalUser[],
})
```

**Auswirkung**: Keine 401-Fehler mehr in Console, sauberere UX.

---

### üü° High: Datenbankfehler beim Laden der Liste
**Problem**: "Ein Datenbankfehler ist aufgetreten" beim √ñffnen von /absences

**Root Cause**:
1. Prisma Schema definiert `AbsenceDocument` Modell
2. Controller versucht `documents` Relation zu laden
3. Tabelle `absence_documents` existiert nicht in DB (Migration Drift)

**Tempor√§re L√∂sung**:
```typescript
// backend/src/controllers/absenceController.ts
const selectAbsence = {
  // ... andere Felder
  // TEMP: documents disabled until migration is fixed
  // documents: {
  //   select: { ... }
  // },
}
```

**Permanente L√∂sung**: TODO ‚Äì Migration Drift beheben (siehe docs/TODO.md)

**Auswirkung**: Absences-Liste l√§dt, aber Dokument-Upload noch nicht verf√ºgbar.

---

## Technische Details

### Deployment
- Docker Image neu gebaut: `docker compose build api`
- Container neu gestartet: `docker compose up -d api`
- Migrations √ºberpr√ºft: `npx prisma migrate deploy`

### Testing
‚úÖ `/api/absences` l√§dt erfolgreich
‚úÖ `/api/absences/:id/preview-warnings` gibt Kapazit√§tswarnungen zur√ºck
‚úÖ Frontend zeigt Liste ohne Fehler
‚ö†Ô∏è Dokument-Upload noch deaktiviert (bekannte Einschr√§nkung)

### Betroffene Komponenten
- Backend Routes: `absenceRoutes.ts`
- Backend Validations: `absenceValidation.ts`
- Backend Controller: `absenceController.ts`
- Frontend: `AbsencesList.tsx`

## Bekannte Einschr√§nkungen

1. **Dokument-Upload deaktiviert**:
   - Grund: `absence_documents` Tabelle fehlt
   - Status: Tempor√§re L√∂sung aktiv
   - ETA Fix: N√§chste Maintenance-Session

2. **Migration Drift**:
   - 2 Migrationen in DB, aber nicht in lokalem Repo
   - Muss sorgf√§ltig synchronisiert werden (keine Datenverluste!)

## Rollback-Plan

Falls Probleme auftreten:
```bash
# Zur√ºck zum vorherigen Image
docker compose down
# Altes Image wiederherstellen
git checkout <previous-commit>
docker compose build api
docker compose up -d
```

## Lessons Learned

1. **Express Routen-Reihenfolge ist kritisch**:
   - Immer spezifische Routen VOR generischen definieren
   - In Zukunft: Lint-Rule oder Test daf√ºr erstellen

2. **Query Validation muss Frontend-Params abdecken**:
   - Zod-Schema und Frontend-Code m√ºssen synchron sein
   - In Zukunft: Shared Types zwischen FE/BE

3. **Migration Drift vermeiden**:
   - Keine direkten DB-√Ñnderungen in Prod
   - Alle Migrationen immer committen

---

**Dokumentiert von**: Claude (Sonnet 4.5)
**Reviewed by**: [User]
**Deployed at**: 2025-10-04 ~17:00 UTC
