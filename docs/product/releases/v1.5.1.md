# Release v1.5.1 - KapazitÃ¤tsmanagement & UX-Verbesserungen ğŸš€

**Release-Datum**: 2025-10-03
**Typ**: Feature Release
**Fokus**: Intelligente KapazitÃ¤tsprÃ¼fung, Manager-Dashboard, Kalender-Ansicht

---

## ğŸ¯ Ãœberblick

Version 1.5.1 erweitert das Abwesenheits-Management um kritische Features fÃ¼r professionelles Personalmanagement im Sicherheitsdienst:

- **KapazitÃ¤tswarnung**: Verhindert Unterbesetzung durch intelligente PrÃ¼fung VOR Genehmigung
- **Objekt-Einarbeitung**: Neues Datenmodell fÃ¼r "Wer darf wo arbeiten?"
- **Manager-Dashboard**: Schneller Ãœberblick Ã¼ber ausstehende AntrÃ¤ge
- **Kalender-Ansicht**: Visualisierung aller Abwesenheiten im Monatskalender

---

## âœ¨ Neue Features

### 1. Intelligente KapazitÃ¤tsprÃ¼fung

**Problem gelÃ¶st**: Manager genehmigte Urlaub â†’ System meldete danach "Unterbesetzung" â†’ Aber Urlaub bereits genehmigt! ğŸ˜±

**Neue LÃ¶sung**:
1. Manager klickt "Genehmigen"
2. System prÃ¼ft **VOR** Genehmigung:
   - Welche Schichten hat der Mitarbeiter?
   - Wie viele Mitarbeiter sind fÃ¼r das Objekt eingearbeitet?
   - Wie viele sind bereits abwesend?
   - Reicht die KapazitÃ¤t? (`verfÃ¼gbar >= benÃ¶tigt`)
3. **Wenn Unterbesetzung droht**:
   ```
   âš ï¸ WARNUNG: Unterbesetzung erkannt!

   â€¢ Nachtschicht Objekt A (Objekt A): BenÃ¶tigt 2, nur 1 verfÃ¼gbar â†’ 1 fehlen

   Trotzdem genehmigen?
   ```
   - **Ja** â†’ Genehmigen (Manager-Entscheidung)
   - **Nein** â†’ Abbruch (Urlaub NICHT genehmigt)

**Technische Details**:
- **Backend**: `checkCapacityWarnings()` in `absenceController.ts`
- **API**: `GET /api/absences/:id/preview-warnings`
- **Logik**:
  1. Alle Schichten des Users im Abwesenheitszeitraum
  2. FÃ¼r jede Schicht:
     - Mitarbeiter mit `ObjectClearance` (eingearbeitet fÃ¼r das Objekt)
     - Minus bereits genehmigte Abwesenheiten
     - Vergleich mit `Shift.requiredEmployees`
  3. Warnung nur bei `verfÃ¼gbar < benÃ¶tigt`

**Besonderheit**:
- âœ… **VACATION**: Warnung VOR Genehmigung
- âŒ **SICKNESS**: Keine Warnung (auto-genehmigt, dagegen kann man nichts tun)

---

### 2. Objekt-Einarbeitung (ObjectClearance)

**Neues Datenmodell**:
```prisma
model ObjectClearance {
  id         String          @id @default(cuid())
  userId     String          // Mitarbeiter
  siteId     String          // Objekt/Standort
  trainedAt  DateTime        // Wann eingearbeitet?
  trainedBy  String?         // Von wem?
  validUntil DateTime?       // Ablaufdatum (optional)
  notes      String?         // Notizen
  status     ClearanceStatus @default(ACTIVE)
}

enum ClearanceStatus {
  ACTIVE    // Aktiv eingearbeitet
  EXPIRED   // Abgelaufen
  REVOKED   // Widerrufen
}
```

**Use Case**:
- Objekt A hat 4 eingearbeitete Mitarbeiter
- Davon braucht man tÃ¤glich 2
- Wenn 3 gleichzeitig Urlaub nehmen â†’ **WARNUNG**
- Auch wenn 20 andere Mitarbeiter frei sind (nicht eingearbeitet)!

**Migration**: `20251003202545_add_object_clearances`

---

### 3. Manager-Dashboard Verbesserungen

**Neue UI-Elemente** (`AbsencesList.tsx`):

1. **Badge mit Anzahl**:
   ```
   Abwesenheiten  [5 ausstehend]
   ```
   - Nur bei ausstehenden AntrÃ¤gen sichtbar
   - Nur fÃ¼r ADMIN/MANAGER

2. **Quick-Filter-Button**:
   ```
   [Ausstehende anzeigen (5)]
   ```
   - Ein Klick â†’ Filtert sofort nach `status: REQUESTED`
   - Keine verpassten UrlaubsantrÃ¤ge mehr!

---

### 4. Kalender-Ansicht

**Neue Komponente**: `AbsencesCalendar.tsx`

**Features**:
- Monatliche Kalenderansicht (Mo-So)
- Farbcodierung:
  - ğŸŸ¢ **GrÃ¼n**: Genehmigt (`APPROVED`)
  - ğŸŸ¡ **Gelb**: Ausstehend (`REQUESTED`)
  - ğŸ”´ **Rot**: Abgelehnt (`REJECTED`)
  - ğŸ”µ **Blau**: Heute
- Zeigt pro Tag:
  - Mitarbeiter-Initialen (z.B. "M.M.")
  - Abwesenheitstyp (z.B. "Urla" fÃ¼r Urlaub)
  - Max. 2 EintrÃ¤ge, dann "+X"
- Navigation:
  - Vorheriger/NÃ¤chster Monat
  - "Heute"-Button
- Legende am unteren Rand

**Toggle**:
- Button "Kalender/Liste" schaltet zwischen Tabelle und Kalender um

---

## ğŸ› Bug-Fixes

### Fix: Admin-erstellte Urlaube wurden auto-genehmigt

**Problem**:
- Admin erstellt Urlaub fÃ¼r Mitarbeiter
- System genehmigte automatisch (`shouldAutoApprove = canManage(actor.role)`)
- Mitarbeiter-Urlaub sollte aber Manager-Freigabe benÃ¶tigen!

**Fix** (`absenceController.ts:192`):
```typescript
// VORHER (FALSCH):
const shouldAutoApprove = type === 'SICKNESS' || canManage(actor.role);

// NACHHER (KORREKT):
const shouldAutoApprove = type === 'SICKNESS';
```

**Ergebnis**:
- âœ… **SICKNESS**: Immer auto-genehmigt (Krankmeldung)
- âœ… **VACATION**: Immer Manager-Freigabe (auch wenn Admin erstellt)
- âœ… **SPECIAL_LEAVE/UNPAID**: Immer Manager-Freigabe

---

## ğŸ“Š GeÃ¤nderte Dateien

### Backend (6 Dateien)
- `prisma/schema.prisma` - ObjectClearance Model + Enum
- `prisma/migrations/20251003202545_add_object_clearances/migration.sql` - Migration
- `src/controllers/absenceController.ts`:
  - `checkCapacityWarnings()` Funktion (Zeile 180-265)
  - `previewCapacityWarnings()` Endpoint (Zeile 346-379)
  - Auto-Approval Fix (Zeile 192)
- `src/routes/absenceRoutes.ts` - Route `GET /:id/preview-warnings`

### Frontend (3 Dateien)
- `src/features/absences/AbsencesCalendar.tsx` - **NEU**: Kalender-Component
- `src/features/absences/AbsencesList.tsx`:
  - Kalender-Integration mit Toggle
  - Manager-Badge + Quick-Filter (Zeile 226-243)
  - `handleApprove()` mit Preview-Check (Zeile 143-168)
- `src/features/absences/api.ts` - `previewCapacityWarnings()` Funktion

---

## ğŸš€ Migration & Upgrade

### Von v1.5.0 zu v1.5.1

#### 1. Prisma Migration
```bash
docker compose exec api npx prisma migrate deploy
```

Migration: `20251003202545_add_object_clearances`
- Erstellt Tabelle `object_clearances`
- Erstellt Enum `ClearanceStatus`
- FÃ¼gt Relationen zu `users` und `sites` hinzu

#### 2. Prisma Client regenerieren
```bash
docker compose exec api npx prisma generate
```

#### 3. Services neu starten
```bash
docker compose restart api
```

#### 4. Testen
- Manager-Login
- Urlaubsantrag genehmigen â†’ PrÃ¼fen ob Preview-Dialog erscheint
- Kalender-Ansicht testen (Toggle-Button)

---

## âš ï¸ Breaking Changes

**KEINE Breaking Changes fÃ¼r API oder Frontend.**

**Hinweise**:
- Neue Tabelle `object_clearances` ist leer nach Migration
- KapazitÃ¤tswarnungen funktionieren erst, wenn ObjectClearances angelegt wurden
- Bis dahin: Warnungen zeigen immer `verfÃ¼gbar: 0` (da keine Clearances)

**Workaround fÃ¼r Entwicklung**:
```sql
-- Beispiel: Alle Mitarbeiter fÃ¼r Objekt "Hauptbahnhof" einarbeiten
INSERT INTO object_clearances (id, user_id, site_id, status, created_at, updated_at)
SELECT
  gen_random_uuid()::text,
  u.id,
  s.id,
  'ACTIVE',
  NOW(),
  NOW()
FROM users u
CROSS JOIN sites s
WHERE s.name = 'Hauptbahnhof';
```

---

## ğŸ”œ NÃ¤chste Schritte (v1.6.0+)

### P1: Detailansicht Urlaubsantrag (User Story)

**Anforderung**:
> "Ich sehe Urlaubsanfrage von XY, gehe drauf und sehe:
> - Will Urlaub von-bis
> - Hat noch X Urlaubstage
> - Nach Genehmigung: Y Tage verbleibend
> - In welchen Objekten arbeitet er
> - Falls Konflikt: Wo genau + Option nach Ersatz suchen
>
> BEVOR ich auf 'Genehmigen' drÃ¼cke."

**Geplante Features**:
1. **Modal/Detailseite** beim Klick auf Abwesenheit
2. **Urlaubstage-Saldo**:
   - VerfÃ¼gbar (z.B. 30 pro Jahr)
   - Bereits genommen (z.B. 12)
   - Beantragt (z.B. 5)
   - Verbleibend nach Genehmigung (z.B. 13)
3. **Objekt-Zuordnungen**:
   - Liste: "Mitarbeiter arbeitet in: Objekt A, Objekt B, Event XY"
   - Einarbeitungs-Status: âœ… Aktiv, â³ Abgelaufen, âŒ Widerrufen
4. **Konflikt-Details**:
   - Betroffene Schichten mit Datum/Uhrzeit
   - KapazitÃ¤t: "BenÃ¶tigt 2, nur 1 verfÃ¼gbar"
   - **Ersatz-Suche**:
     - Button "Ersatz finden"
     - Zeigt verfÃ¼gbare Mitarbeiter MIT Clearance fÃ¼r das Objekt
     - Direktes Zuweisen zur Schicht

**Technische Umsetzung**:
- Backend: `GET /api/absences/:id/details` (erweiterter Endpoint)
- Frontend: `AbsenceDetailModal.tsx` (neue Komponente)
- Urlaubstage-Berechnung: Neues Feld `EmployeeProfile.annualLeaveDays`

---

### P2: Objekt-Verwaltung UI

**Geplant**:
- Objekte anlegen mit vollstÃ¤ndiger Planung
- Dokumente hochladen (VertrÃ¤ge, PlÃ¤ne, Abrechnungsdaten)
- RBAC: Was darf Mitarbeiter sehen vs. Chef?
- Tagesbedarf konfigurieren (feste Schichten vs. dynamisch)

---

### P2: Einarbeitungs-Management

**Geplant**:
- UI zum Erstellen/Bearbeiten von `ObjectClearance`
- "Mitarbeiter XY fÃ¼r Objekt Z einarbeiten"
- Ablaufdatum verwalten
- Status Ã¤ndern (ACTIVE/EXPIRED/REVOKED)

---

### P3: Event-Planung

**Geplant**:
- GroÃŸe Events (15+ Mitarbeiter) erfassen
- Automatische KapazitÃ¤tsprÃ¼fung bei Event-Erstellung
- Partner-Firmen-Integration

---

## ğŸ“ Dokumentation

### Aktualisiert
- `docs/releases/v1.5.1.md` - Diese Release Notes
- `docs/TODO.md` - NÃ¤chste Features dokumentiert

### Relevant
- `docs/planning/absences.md` - Abwesenheiten-Planung
- `backend/prisma/schema.prisma` - ObjectClearance Datenmodell

---

## ğŸ“Š Statistiken

- **9 Dateien geÃ¤ndert**
- **+547 Zeilen** hinzugefÃ¼gt
- **-89 Zeilen** gelÃ¶scht
- **1 neue Migration**
- **1 neuer Frontend-Component**
- **2 neue API-Endpoints**

---

## ğŸ™ Danke

Besonderer Dank fÃ¼r das wertvolle Feedback zur UX!

---

**GitHub Tag**: `v1.5.1`
**Docker Image**: `sicherheitsdienst-api:1.5.1`

ğŸ¤– Erstellt mit [Claude Code](https://claude.com/claude-code)
