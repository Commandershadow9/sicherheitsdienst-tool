# Analyse – Sicherheitsdienst-Tool Backend (2025-09-09)

## 1) Executive Summary (8–12 Zeilen)
- Domäne: Backend für Sicherheitsdienst-Management (Mitarbeiter, Sites, Schichten, Zeiterfassung, Einsätze/Events, Benachrichtigungen).
- Architektur: Node.js/Express 5 + TypeScript, Prisma/PostgreSQL; Schichten: routes → controllers → services/middleware → Prisma; zentrale Fehlerbehandlung.
- API: Umfangreiche OpenAPI 3.1 (docs/openapi.yaml), DEV-Swagger-UI; Versionierung via Alias `/api/v1`.
- Auth: JWT-Login/Refresh, `GET /auth/me`, RBAC-Middleware (`authenticate`, `authorize`, `authorizeSelfOr`) und Tests.
- Validierung/Fehler: Zod-Validierung; konsistenter Fehler-Body; 400/401/403/404/409/422/429/503 mapping vorhanden.
- TimeTracking: Clock-in/out pro Schicht inkl. Plausibilitätswarnungen; Zuweisungen und Exporte (CSV/XLSX).
- Notifications: E-Mail (optional, ENV-Flag), Push (DeviceTokens + optional FCM; Events-Push via Flag).
- Persistenz: Prisma-Schema + Migrationen (DeviceTokens, Events, Indizes); Compose führt `prisma migrate deploy` aus.
- Tests/CI: Umfangreiche Jest-Tests (RBAC, Validation, Routen, Exporte, E-Mail/Push); CI mit Typecheck/Build/Coverage + OpenAPI-Validate/Lint.
- Doku/Operability: README mit Quickstarts, `.env.example` vollständig; ROADMAP/TODO vorhanden; Konzept liegt als `docs/KONZEPT.pdf` (kein Konzept.md).

## 2) Reifegrad-Matrix (0–5)
| Bereich                      | Score |
|-----------------------------|-------|
| Architektur/Modularität     | 4     |
| Auth/RBAC                   | 4     |
| Validierung & Fehlerbilder  | 4     |
| TimeTracking/Business-Logik | 3     |
| Notifications (Mail/Trigger)| 3     |
| Persistenz/DB-Migrationen   | 4     |
| Testabdeckung/CI-Gesundheit | 4     |
| Doku/Operability            | 4     |

## 3) Top Lücken/Blocker (5)
- OpenAPI-Drift: Incidents in `docs/openapi.yaml` definiert, aber keine Routen/Controller im Code – Implementierung fehlt.
- Fehler-Schema in OpenAPI: `ErrorResponse` ohne `success:false`, Backend liefert stets `success:false` → Divergenz.
- Prisma-Instanziierung: Mehrfacher `new PrismaClient()`; fehlende zentrale Singleton-Nutzung kann Ressourcen binden.
- Rate Limiting: Nur Test-Endpoint limitiert; kein Limit auf sensiblen Endpunkten (auth/login, refresh).
- Observability: Basis `/stats` vorhanden, aber keine Request-ID/Correlation oder Metriken/Tracing.

## 4) Top Risiken (5)
- JWT-Claims-Härtung: Keine `aud/iss/nbf`-Prüfung – Risiko bei Integrationen.
- OpenAPI-Konformität: Spec-Drift (Incidents, Error-Schema) gefährdet Client-Generierung/QA.
- E-Mail/Push Zuverlässigkeit: SMTP/FCM optional, kein Retry/Monitoring – Zustellrisiken.
- Migrations-Funktionsnamen: `set_updated_at()` mehrfach definiert – technisch okay, aber verwirrend bei Folgeänderungen.
- Export-Last: CSV/XLSX im Request-Thread – Risiko für Latenz/Memory bei großen Datenmengen.

## 5) Nächster Meilenstein
- Titel: Incidents E2E + Spec Alignment + Observability Lite
- Scope (in): Implementierung Incidents CRUD/Listen/Filter/Exporte; OpenAPI/Backend-Fehlerschema harmonisieren; Request-ID Middleware; Rate-Limit für auth-Endpunkte; Fehlerbeispiele in OpenAPI.
- Scope (out): Volles Alerting/Tracing; asynchrone Queue; erweiterter Audit-Trail.
- Akzeptanzkriterien:
  1. Given OpenAPI /incidents, When CRUD/Listen, Then Antworten/Status passen inkl. RBAC (ADMIN/MANAGER schreiben, AUTH lesen).
  2. Given Validierungsfehler, When Payload invalid, Then 422 `{ success:false, code:'VALIDATION_ERROR', errors:[...] }` (Spec und Code konsistent).
  3. Given beliebiger Fehler, When 4xx/5xx, Then `success:false` + normiertes `code` (README/OpenAPI konsistent).
  4. Given API-Request, When Logs geprüft, Then `X-Request-ID` als Header und im Log vorhanden.
  5. Given auth/login|refresh Flood, When Rate-Limit, Then 429 mit `Retry-After`; ENV dokumentiert.
  6. Given Incidents-Liste, When Accept CSV/XLSX, Then korrekter Export mit Filter/Sort/Pagination.
- API-/Schema-Änderungen:
  - OpenAPI: `ErrorResponse` um `success:boolean` erweitern, Beispiele angleichen.
  - OpenAPI: Incidents-Pfade/Schemas finalisieren (RBAC, Filter, Exporte, Beispiele).
  - Optional: `X-Request-ID` als Header dokumentieren.
- Teststrategie & Observability:
  - Unit: Zod für Incidents; RBAC-Guards; Fehler-Mapping.
  - Integration: CRUD/Listen/Exporte inkl. 401/403/404/422/429.
  - API-Flows: Supertest-Beispiele (Login→CRUD→Export); Fehlerbeispiele in Docs.
  - Observability: Middleware-Test für Request-ID; `/stats` optional erweitern.
- Risiken & Gegenmaßnahmen:
  - Datenvolumen Exporte → Pagination/Streaming; Timeouts/Size-Limits.
  - RBAC-Edge-Cases → Negative Tests für EMPLOYEE/MANAGER; kein Self-Access bei Incidents.
  - Spec-Drift → CI behält OpenAPI validate/lint; optional contract tests (später).
  - Rate-Limit False-Positives → ENV-Tuning + Tests für Fenster/Schwellen.
- Aufwände (S/M/L): Incidents CRUD+Export (M), Error/Spec-Harmonisierung (S), Request-ID (S), Rate-Limit auth (S), Tests (M) → Gesamt M–L.

## 6) Ticketliste (P0→P2)
- P0: Implement Incidents CRUD + List/Filter/Export (routes/controller/validations; Prisma) — DoD: Tests grün (CRUD/RBAC/422/404), Exporte CSV/XLSX, OpenAPI deckungsgleich.
- P0: Harmonize ErrorResponse in OpenAPI (+Examples) mit Backend-Format — DoD: `success:boolean` in Components, CI OpenAPI-Validate/Lint ok, Smoke-Tests prüfen Shape.
- P1: Add Request-ID middleware + log correlation (winston) — DoD: Header `X-Request-ID` akzeptiert/gesetzt, Logger gibt ID aus, Test prüft Präsenz.
- P1: Rate-limit auth/login + auth/refresh (configurable) — DoD: 429 mit Retry-After; ENV in .env.example; Tests für enabled/disabled.
- P1: PrismaClient Singleton factory (backend/src/utils/prisma.ts) — DoD: Alle Module nutzen Singleton; Tests laufen; keine Mehrfachverbindungen.
- P1: Extend /stats mit basic Counters (requests, 4xx/5xx, rate-limit cfg) — DoD: Felder dokumentiert + getestet.
- P2: OpenAPI error examples für Push/Email (5xx, 429) — DoD: Beispiele ergänzt; Lint ok.
- P2: README Operations/Runbook (Deploy/Runbook, ENV Matrix) — DoD: Abschnitt hinzugefügt, referenziert docker-compose/healthchecks.
- P2: Document 404/405 in OpenAPI Components — DoD: Components/Responses ergänzt; CI-Lint ok.
- P2: E-Mail Retry Policy (einfacher 1x Retry) — DoD: Service mit Retry-Option, Unit-Test.

## 7) Offene Fragen/Annahmen
- Sollen Incidents analog zu Events Exporte (CSV/XLSX) und RBAC (ADMIN/MANAGER schreiben) bekommen? Annahme: ja.
- Sollen Erfolgsantworten ein `success:boolean` enthalten oder nur Fehler? Annahme: nur Fehler nutzen `success:false`; Erfolg wie bisher.
- Dürfen EMPLOYEE Incidents lesen (alle vs. nur eigene)? Annahme: AUTH lesen alle; alternativ Filter „reportedBy=self“ (zu entscheiden).
- Globales Rate-Limiting gewünscht oder nur auth-Endpunkte?
- FCM produktiv geplant oder vorerst Mock-only? Beeinflusst Observability/Troubleshooting.

## 8) Hinweis
Wenn gewünscht, PR auf Branch `planning/analysis-20250909` öffnen, damit die Tickets/Struktur abgestimmt werden können.

