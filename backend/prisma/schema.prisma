generator client {
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
  provider      = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Benutzer/Mitarbeiter
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)

  // üîê MULTI-TENANCY: Kunden-Zuordnung (KRITISCH f√ºr Datenisolation)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  // Arbeitsbezogene Informationen
  employeeId     String?   @unique
  hireDate       DateTime?
  qualifications String[] // Array von Qualifikationen
  pushOptIn      Boolean   @default(true)
  emailOptIn     Boolean   @default(true)

  // Lohn-Konfiguration (Flexibles Lohnsystem)
  wageGroup         String?  // BSDW Lohngruppe (GRUPPE_1 bis GRUPPE_7)
  baseWageOverride  Decimal? @db.Decimal(6, 2) // Individueller Stundenlohn (√ºbersteuert Tarif)
  activityWages     Json?    // T√§tigkeits-spezifische L√∂hne: { "VERANSTALTUNG": 17.00, "BEWAFFNET": 22.00 }

  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beziehungen
  shifts                ShiftAssignment[]
  timeEntries           TimeEntry[]
  incidents             Incident[]
  profile               EmployeeProfile?
  absencesRequested     Absence[]             @relation("AbsenceUser")
  absencesCreated       Absence[]             @relation("AbsenceCreatedBy")
  absencesDecided       Absence[]             @relation("AbsenceDecidedBy")
  documentsUploaded     EmployeeDocument[]    @relation("EmployeeDocumentUploadedBy")
  objectClearances      ObjectClearance[]
  clearancesTrained     ObjectClearance[]     @relation("ClearanceTrainer")
  clearancesApproved    ObjectClearance[]     @relation("ClearanceApprover")
  siteImagesUploaded    SiteImage[]           @relation("SiteImageUploader")
  siteAssignments       SiteAssignment[]      @relation("SiteAssignmentUser")
  siteDocumentsUploaded SiteDocument[]        @relation("SiteDocumentUploader")
  siteIncidentsReported SiteIncident[]        @relation("SiteIncidentReporter")
  incidentHistoryEntries IncidentHistory[]    @relation("IncidentHistoryUser")
  deviceTokens          DeviceToken[]
  controlRounds         ControlRound[]        @relation("ControlRoundPerformer")
  controlScans          ControlScan[]         @relation("ControlScanScanner")
  calculationsCalculated SiteCalculation[]    @relation("CalculationCalculator")
  preferences           EmployeePreferences?
  shiftPreferences      EmployeeShiftPreference[]
  workload              EmployeeWorkload[]
  complianceViolations  ComplianceViolation[]

  @@index([lastName, firstName], name: "users_name_idx")
  @@index([createdAt], name: "users_createdAt_idx")
  @@index([isActive], name: "users_isActive_idx")
  @@index([role], name: "users_role_idx")
  @@index([customerId], name: "users_customer_idx") // üîê Multi-Tenancy Index
  @@map("users")
}

// Einsatzorte/Sites
// Kunden-Verwaltung
model Customer {
  id          String @id @default(cuid())
  companyName String @unique

  // Branche & Stammdaten
  industry String? // z.B. "Einzelhandel", "Industrie", "B√ºrogeb√§ude"
  taxId    String? @unique

  // Haupt-Ansprechpartner (JSON: { name, email, phone, position })
  primaryContact Json

  // Weitere Ansprechpartner (JSON-Array)
  contacts Json[] @default([])

  // Firmensitz-Adresse
  address    String
  city       String
  postalCode String
  country    String @default("Deutschland")

  // Rechnungsadresse (falls abweichend, JSON: { address, city, postalCode, country })
  billingAddress Json?

  // Vertragsdaten
  paymentTerms String  @default("30 Tage netto")
  discount     Decimal? @db.Decimal(5, 2) // z.B. 5% Stammkunden-Rabatt

  // Notizen & Besonderheiten
  notes String? @db.Text

  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beziehungen
  sites Site[]
  users User[] // üîê Multi-Tenancy: Kunden haben User

  @@index([companyName])
  @@map("customers")
}

model Site {
  id         String @id @default(cuid())
  name       String
  address    String
  city       String
  postalCode String

  // Kunden-Relation (NEU)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  // Legacy Kunden-Felder (f√ºr Abw√§rtskompatibilit√§t)
  customerName    String?
  customerCompany String?
  customerEmail   String?
  customerPhone   String?

  // Geb√§ude-Informationen (NEU f√ºr Wizard)
  buildingType BuildingType? // OFFICE, INDUSTRIAL, RETAIL, EVENT, CONSTRUCTION, OTHER
  floorCount   Int?
  squareMeters Int?

  // Geo-Koordinaten (NEU f√ºr Google Maps)
  geoLat Decimal? @db.Decimal(10, 8)
  geoLng Decimal? @db.Decimal(11, 8)

  // Notfallkontakte (JSON-Array: [{ name, phone, role }])
  emergencyContacts Json?

  // Objekt-Status
  status SiteStatus @default(ACTIVE)

  // Anforderungen
  requiredStaff          Int      @default(1)
  requiredQualifications String[] @default([])

  // Lohn-Konfiguration (Flexibles Lohnsystem)
  siteWageOverride Decimal? @db.Decimal(6, 2) // Objekt-spezifischer Stundenlohn (h√∂chste Priorit√§t)

  // Sicherheitskonzept (NEU f√ºr Wizard)
  // JSON: { tasks: [], intervals: [], shiftModel: "", hoursPerWeek: 168 }
  securityConcept Json?

  // Wizard-Status (NEU)
  wizardCompleted Boolean @default(false)
  wizardStep      Int     @default(0)

  // ===== SCHICHTPLANUNG ERWEITERUNGEN (v2.0) =====
  // Standard-Schichtmodell f√ºr dieses Objekt
  defaultShiftTemplateId String?        @map("default_shift_template_id")
  defaultShiftTemplate   ShiftTemplate? @relation(fields: [defaultShiftTemplateId], references: [id], onDelete: SetNull)

  // Mindestbesetzung (√ºberschreibt Template-Wert)
  minStaffRequirement Int  @default(1) @map("min_staff_requirement")
  maxStaffCapacity    Int? @map("max_staff_capacity") // Optional: Maximale Kapazit√§t

  // Kritische Zeiten (JSON: ["22:00-06:00", "weekends"])
  criticalHours Json? @map("critical_hours")

  // Automatische Schicht-Generierung aktiviert?
  autoGenerateShifts Boolean @default(false) @map("auto_generate_shifts")

  // Beschreibung & Notizen
  description String? @db.Text
  notes       String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beziehungen
  shifts                Shift[]
  shiftRules            ShiftRule[]
  events                Event[]
  clearances            ObjectClearance[]
  images                SiteImage[]
  assignments           SiteAssignment[]
  documents             SiteDocument[]
  incidents             SiteIncident[]
  controlPoints         ControlPoint[]
  controlRounds         ControlRound[]
  calculations          SiteCalculation[]
  // securityConcepts      SecurityConcept[]  // TODO: Create migration for this table
  employeePreferences   EmployeeShiftPreference[]

  @@unique([name, address], name: "sites_name_address_key")
  @@index([name], name: "sites_name_idx")
  @@index([city], name: "sites_city_idx")
  @@index([postalCode], name: "sites_postal_idx")
  @@index([status], name: "sites_status_idx")
  @@index([customerId], name: "sites_customer_idx")
  @@map("sites")
}

// Geb√§ude-Typen
enum BuildingType {
  OFFICE       // B√ºrogeb√§ude
  INDUSTRIAL   // Industrie/Produktion
  RETAIL       // Einzelhandel
  EVENT        // Event-Location
  CONSTRUCTION // Baustelle
  OTHER        // Sonstiges
}

// Objekt-Vorlagen f√ºr schnelle Anlage
model SiteTemplate {
  id          String @id @default(cuid())
  name        String // z.B. "24/7 Objektschutz Standard"
  description String? @db.Text

  buildingType BuildingType

  // Template-Daten
  hoursPerWeek          Int
  shiftModel            String // "2-SHIFT", "3-SHIFT", "ROTATING"
  requiredStaff         Int
  requiredQualifications String[] @default([])
  tasks                 String[] @default([]) // ["ACCESS_CONTROL", "PATROLS", "RECEPTION"]

  // Kalkulations-Basis
  basePrice Decimal @db.Decimal(10, 2)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_templates")
}

// ===== SCHICHTPLANUNG v2.0: WIEDERVERWENDBARE SCHICHTMUSTER =====

// Schichtvorlagen (Wiederverwendbare Muster f√ºr Schichten)
model ShiftTemplate {
  id          String  @id @default(cuid())
  name        String // z.B. "Fr√ºhschicht Standard", "24h Wochenende"
  description String? @db.Text

  // Schicht-Konfiguration
  shiftType ShiftType @default(REGULAR) @map("shift_type") // REGULAR, NIGHT, WEEKEND, HOLIDAY

  // Zeitdefinition
  startTime String // "06:00" (HH:mm Format)
  endTime   String // "14:00"
  duration  Int? // Dauer in Stunden (berechnet oder manuell)

  // Personal-Anforderungen
  requiredStaff          Int      @default(1) @map("required_staff")
  requiredQualifications String[] @default([]) @map("required_qualifications")

  // Schichtmodell-Zuordnung
  shiftModelType String? @map("shift_model_type") // "2-SHIFT", "3-SHIFT", "24/7", "ROTATING"

  // Zuschl√§ge & Besonderheiten
  nightShift    Boolean @default(false) @map("night_shift") // 22-6 Uhr
  weekendShift  Boolean @default(false) @map("weekend_shift")
  holidayShift  Boolean @default(false) @map("holiday_shift")
  wageMultiplier Decimal? @default(1.0) @db.Decimal(4, 2) @map("wage_multiplier") // z.B. 1.25 f√ºr 25% Zuschlag

  // Farbe f√ºr UI (Hex-Code)
  color String? @default("#3B82F6") // Blau als Default

  // Anwendbarkeit
  applicableDays Int[] @default([1, 2, 3, 4, 5]) @map("applicable_days") // 0=So, 1=Mo, ..., 6=Sa

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Kategorisierung
  category String? // "STANDARD", "SPECIAL", "EMERGENCY"

  // Metadaten
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Beziehungen
  sites Site[] // Sites die dieses Template als Default nutzen

  @@index([shiftType], name: "shift_templates_type_idx")
  @@index([isActive], name: "shift_templates_active_idx")
  @@map("shift_templates")
}

enum ShiftType {
  REGULAR // Regul√§re Schicht (Mo-Fr, Tag)
  NIGHT // Nachtschicht
  WEEKEND // Wochenende
  HOLIDAY // Feiertag
  EMERGENCY // Notfall/Sonderfall
  SPECIAL // Sonderveranstaltung
}

// Benutzerrollen
enum UserRole {
  ADMIN
  MANAGER
  DISPATCHER
  EMPLOYEE
}

// Schichten/Dienste
model Shift {
  id          String   @id @default(cuid())
  siteId      String?
  site        Site?    @relation(fields: [siteId], references: [id])
  title       String
  description String?
  location    String
  startTime   DateTime
  endTime     DateTime

  // Anforderungen
  requiredEmployees      Int      @default(1)
  requiredQualifications String[]

  // Status
  status ShiftStatus @default(PLANNED)

  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beziehungen
  assignments          ShiftAssignment[]
  timeEntries          TimeEntry[]
  complianceViolations ComplianceViolation[]
  incidents            SiteIncident[]        @relation("SiteIncidentShift")
  controlRounds        ControlRound[]

  @@index([startTime], name: "shifts_startTime_idx")
  @@index([status], name: "shifts_status_idx")
  @@index([siteId, startTime], name: "shifts_site_start_idx")
  @@map("shifts")
}

enum ShiftStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// ===== SHIFT PLANNING RULES (Advanced Scheduling) =====

// Schichtplanungs-Regeln (Wiederholungsmuster f√ºr automatische Schicht-Generierung)
model ShiftRule {
  id     String @id @default(cuid())
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Schicht-Definition
  name                   String // z.B. "Fr√ºhschicht Mo-Fr"
  startTime              String // "06:00"
  endTime                String // "14:00"
  requiredStaff          Int    @default(1)
  requiredQualifications String[] @default([])

  // Wiederholungs-Muster
  pattern       RulePattern @default(WEEKLY)
  daysOfWeek    Int[] // [1,2,3,4,5] = Mo-Fr, [6,0] = Sa-So, 0=Sonntag, 1=Montag, ...
  specificDates DateTime[] // Konkrete Daten (f√ºr pattern=SPECIFIC_DATES)

  // G√ºltigkeit
  validFrom  DateTime
  validUntil DateTime?

  // Priorit√§t (h√∂her = √ºberschreibt niedrigere Regeln, f√ºr Ausnahmen)
  // Basis-Regeln: 0, Ausnahmen: 10+
  priority Int @default(0)

  // Status
  isActive Boolean @default(true)

  // Metadaten
  description String? @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId, validFrom], name: "shift_rules_site_valid_idx")
  @@index([siteId, isActive], name: "shift_rules_site_active_idx")
  @@index([pattern], name: "shift_rules_pattern_idx")
  @@map("shift_rules")
}

enum RulePattern {
  DAILY          // Jeden Tag (validFrom bis validUntil)
  WEEKLY         // Bestimmte Wochentage (daysOfWeek)
  SPECIFIC_DATES // Nur an bestimmten Daten (specificDates)
  DATE_RANGE     // Jeden Tag in Zeitraum (alternative zu DAILY)
}

// Zuweisungen von Mitarbeitern zu Schichten
model ShiftAssignment {
  id String @id @default(cuid())

  // Beziehungen
  userId  String
  shiftId String
  user    User   @relation(fields: [userId], references: [id])
  shift   Shift  @relation(fields: [shiftId], references: [id])

  // Status
  status AssignmentStatus @default(ASSIGNED)

  // Zeitstempel
  assignedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, shiftId])
  @@index([shiftId], name: "shift_assignments_shift_idx")
  @@map("shift_assignments")
}

enum AssignmentStatus {
  ASSIGNED
  CONFIRMED
  STARTED
  COMPLETED
  CANCELLED
}

// Zeiterfassung
model TimeEntry {
  id String @id @default(cuid())

  // Beziehung
  userId  String
  user    User    @relation(fields: [userId], references: [id])
  shiftId String?
  shift   Shift?  @relation(fields: [shiftId], references: [id])

  // Zeitdaten
  startTime DateTime
  endTime   DateTime?
  breakTime Int? // Pause in Minuten

  // Location (Optional f√ºr GPS)
  startLocation String?
  endLocation   String?

  // Notizen
  notes String?

  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startTime], name: "time_entries_user_start_idx")
  @@map("time_entries")
}

// Vorf√§lle
model Incident {
  id          String           @id @default(cuid())
  title       String
  description String
  severity    IncidentSeverity
  status      IncidentStatus   @default(OPEN)

  // Ort und Zeit
  location   String
  occurredAt DateTime

  // Beziehung
  reportedBy String
  user       User   @relation(fields: [reportedBy], references: [id])

  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("incidents")
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model EmployeeProfile {
  id                 String         @id @default(cuid())
  userId             String         @unique @map("user_id")
  address            Json?
  birthDate          DateTime?      @map("birth_date")
  phone              String?
  employmentType     EmploymentType @default(FULL_TIME) @map("employment_type")
  employmentStart    DateTime?      @map("employment_start")
  employmentEnd      DateTime?      @map("employment_end")
  workSchedule       String?        @map("work_schedule")
  hourlyRate         Decimal?       @map("hourly_rate") @db.Decimal(10, 2)
  weeklyTargetHours  Int?           @map("weekly_target_hours")
  monthlyTargetHours Int?           @map("monthly_target_hours")
  annualLeaveDays    Int            @default(30) @map("annual_leave_days")

  // Intelligent Replacement System - v1.8.0
  targetWeeklyHours     Float   @default(40) @map("target_weekly_hours")
  contractType          String  @default("FULL_TIME") @map("contract_type")
  autoAcceptReplacement Boolean @default(false) @map("auto_accept_replacement")

  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user           User                    @relation(fields: [userId], references: [id])
  qualifications EmployeeQualification[]
  documents      EmployeeDocument[]

  @@map("employee_profiles")
}

model EmployeeQualification {
  id          String    @id @default(cuid())
  profileId   String    @map("profile_id")
  title       String
  description String?
  validFrom   DateTime? @map("valid_from")
  validUntil  DateTime? @map("valid_until")

  profile EmployeeProfile @relation(fields: [profileId], references: [id])

  @@index([profileId, validUntil], name: "employee_qualifications_profile_valid_idx")
  @@map("employee_qualifications")
}

model EmployeeDocument {
  id         String           @id @default(cuid())
  profileId  String           @map("profile_id")
  category   DocumentCategory
  filename   String
  mimeType   String           @map("mime_type")
  size       Int
  storedAt   String           @map("stored_at")
  issuedAt   DateTime?        @map("issued_at")
  expiresAt  DateTime?        @map("expires_at")
  uploadedBy String           @map("uploaded_by")
  createdAt  DateTime         @default(now()) @map("created_at")

  profile  EmployeeProfile @relation(fields: [profileId], references: [id])
  uploader User            @relation("EmployeeDocumentUploadedBy", fields: [uploadedBy], references: [id])

  @@index([profileId], name: "employee_documents_profile_idx")
  @@index([category], name: "employee_documents_category_idx")
  @@index([expiresAt], name: "employee_documents_expires_idx")
  @@map("employee_documents")
}

// ==================== Intelligent Replacement System (v1.8.0) ====================

// Mitarbeiter-Pr√§ferenzen f√ºr intelligente Schichtzuweisung
model EmployeePreferences {
  id     String @id @default(cuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Schicht-Pr√§ferenzen
  prefersNightShifts Boolean @default(false) @map("prefers_night_shifts")
  prefersDayShifts   Boolean @default(true) @map("prefers_day_shifts")
  prefersWeekends    Boolean @default(false) @map("prefers_weekends")

  // Stunden-Pr√§ferenzen
  targetMonthlyHours Int     @default(160) @map("target_monthly_hours")
  minMonthlyHours    Int     @default(120) @map("min_monthly_hours")
  maxMonthlyHours    Int     @default(200) @map("max_monthly_hours")
  flexibleHours      Boolean @default(true) @map("flexible_hours")

  // Schicht-L√§nge Pr√§ferenzen
  prefersLongShifts  Boolean @default(false) @map("prefers_long_shifts")
  prefersShortShifts Boolean @default(false) @map("prefers_short_shifts")

  // Arbeitsrhythmus
  prefersConsecutiveDays Int? @default(5) @map("prefers_consecutive_days")
  minRestDaysPerWeek     Int  @default(2) @map("min_rest_days_per_week")

  // Site/Location Pr√§ferenzen
  preferredSiteIds String[] @map("preferred_site_ids")
  avoidedSiteIds   String[] @map("avoided_site_ids")

  // Sonstiges
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId], name: "employee_preferences_user_idx")
  @@map("employee_preferences")
}

// ===== SCHICHTPLANUNG v2.0: ERWEITERTE SCHICHT-PR√ÑFERENZEN =====

// Mitarbeiter-Schicht-Pr√§ferenzen (Granulare Kontrolle pro Site/Schicht)
model EmployeeShiftPreference {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Site-spezifische Pr√§ferenzen (optional)
  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Schicht-Typ Pr√§ferenzen (JSON: { "MORNING": 10, "NIGHT": 2, "WEEKEND": 5 })
  // Werte: 1-10 (1=ungern, 10=bevorzugt)
  shiftTypePreferences Json? @default("{}") @map("shift_type_preferences")

  // Zeit-Pr√§ferenzen (JSON: { "06:00-14:00": 10, "14:00-22:00": 7, "22:00-06:00": 3 })
  timeSlotPreferences Json? @default("{}") @map("time_slot_preferences")

  // Wochentag-Pr√§ferenzen (JSON: { "0": 5, "1": 10, "2": 10, ..., "6": 7 })
  // 0=Sonntag, 1=Montag, ..., 6=Samstag
  weekdayPreferences Json? @default("{}") @map("weekday_preferences")

  // Blackout-Zeiten (Zeiten zu denen MA NICHT arbeiten will)
  // JSON: [{ "start": "2025-12-24T00:00:00Z", "end": "2025-12-26T23:59:59Z", "reason": "Weihnachten" }]
  blackoutPeriods Json? @default("[]") @map("blackout_periods")

  // Bevorzugte maximale Schichtl√§nge (in Stunden)
  maxPreferredShiftLength Int? @default(8) @map("max_preferred_shift_length")
  minPreferredShiftLength Int? @default(6) @map("min_preferred_shift_length")

  // Bevorzugte Arbeitsrhythmus
  preferredConsecutiveDays Int? @default(5) @map("preferred_consecutive_days") // 5 Tage am St√ºck
  preferredRestDays        Int? @default(2) @map("preferred_rest_days") // 2 Tage Pause

  // Bereitschaft f√ºr Vertretungen
  availableForReplacement Boolean @default(true) @map("available_for_replacement")
  replacementPriority     Int     @default(5) @map("replacement_priority") // 1-10 (10=sehr bereit)

  // Flexibilit√§t-Score (automatisch berechnet basierend auf Pr√§ferenzen)
  flexibilityScore Int? @default(50) @map("flexibility_score") // 0-100

  // Notizen
  notes String? @db.Text

  // Metadaten
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, siteId], name: "employee_shift_preferences_user_site_key")
  @@index([userId], name: "employee_shift_preferences_user_idx")
  @@index([siteId], name: "employee_shift_preferences_site_idx")
  @@index([availableForReplacement], name: "employee_shift_preferences_replacement_idx")
  @@map("employee_shift_preferences")
}

// Workload-Tracking (Performance-optimiert f√ºr Scoring-Engine)
model EmployeeWorkload {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Zeitraum
  month Int // 1-12
  year  Int // 2025

  // Aggregierte Metriken (gecached f√ºr Performance)
  totalHours            Float @default(0) @map("total_hours")
  scheduledHours        Float @default(0) @map("scheduled_hours")
  nightShiftCount       Int   @default(0) @map("night_shift_count")
  weekendShiftCount     Int   @default(0) @map("weekend_shift_count")
  consecutiveDaysWorked Int   @default(0) @map("consecutive_days_worked")
  restDaysCount         Int   @default(0) @map("rest_days_count")

  // Compliance-Checks
  maxWeeklyHours            Float  @default(0) @map("max_weekly_hours")
  minRestHoursBetweenShifts Float? @default(11) @map("min_rest_hours_between_shifts")

  // Fairness-Score (0-100)
  fairnessScore Int? @map("fairness_score")

  // Metadata
  lastCalculated DateTime @default(now()) @map("last_calculated")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([userId, month, year], name: "employee_workload_user_period_key")
  @@index([userId, year, month], name: "employee_workloads_user_period_idx")
  @@index([year, month], name: "employee_workloads_period_idx")
  @@map("employee_workloads")
}

// Compliance-Violations (Log f√ºr Arbeitszeit-Verst√∂√üe)
model ComplianceViolation {
  id     String @id @default(cuid())
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  shiftId String? @map("shift_id")
  shift   Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  violationType String @map("violation_type") // "REST_TIME_VIOLATED", "WEEKLY_HOURS_EXCEEDED", "CONSECUTIVE_DAYS_EXCEEDED"
  severity      String @map("severity") // "WARNING", "ERROR", "CRITICAL"
  description   String @db.Text // "Ruhezeit nur 9h statt gesetzlich 11h"

  value     Float? // Tats√§chlicher Wert (z.B. 9.0 f√ºr 9h Ruhezeit)
  threshold Float? // Grenzwert (z.B. 11.0 f√ºr 11h Mindestpause)

  resolvedAt   DateTime? @map("resolved_at")
  resolvedBy   String?   @map("resolved_by")
  resolvedNote String?   @map("resolved_note") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt], name: "compliance_violations_user_created_idx")
  @@index([violationType, severity], name: "compliance_violations_type_severity_idx")
  @@map("compliance_violations")
}

// ==================== End Intelligent Replacement System ====================

model Absence {
  id           String        @id @default(cuid())
  userId       String        @map("user_id")
  createdById  String        @map("created_by_id")
  decidedById  String?       @map("decided_by_id")
  type         AbsenceType
  status       AbsenceStatus @default(REQUESTED)
  startsAt     DateTime      @map("starts_at")
  endsAt       DateTime      @map("ends_at")
  reason       String?       @db.Text
  decisionNote String?       @map("decision_note") @db.Text
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  user      User              @relation("AbsenceUser", fields: [userId], references: [id])
  createdBy User              @relation("AbsenceCreatedBy", fields: [createdById], references: [id])
  decidedBy User?             @relation("AbsenceDecidedBy", fields: [decidedById], references: [id])
  documents AbsenceDocument[]

  @@index([status], name: "absences_status_idx")
  @@index([type], name: "absences_type_idx")
  @@index([startsAt], name: "absences_start_idx")
  @@index([userId, startsAt], name: "absences_user_start_idx")
  @@map("absences")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  MINI_JOB
  TEMPORARY
  CONTRACTOR
}

enum DocumentCategory {
  FIREARM_LICENSE
  WARNING_LETTER
  CONTRACT
  TRAINING_CERTIFICATE
  MEDICAL_CERTIFICATE
  OTHER
}

enum AbsenceType {
  VACATION
  SICKNESS
  SPECIAL_LEAVE
  UNPAID
}

enum AbsenceStatus {
  REQUESTED
  APPROVED
  REJECTED
  CANCELLED
}

// Abwesenheits-Dokumente (z.B. Krankschreibungen, Atteste)
model AbsenceDocument {
  id         String   @id @default(cuid())
  absenceId  String   @map("absence_id")
  filename   String
  mimeType   String   @map("mime_type")
  size       Int
  storedAt   String   @map("stored_at")
  uploadedBy String   @map("uploaded_by")
  createdAt  DateTime @default(now()) @map("created_at")

  absence Absence @relation(fields: [absenceId], references: [id], onDelete: Cascade)

  @@index([absenceId], name: "absence_documents_absence_idx")
  @@map("absence_documents")
}

// Objekt-Einarbeitung / Clearance
model ObjectClearance {
  id         String          @id @default(cuid())
  userId     String          @map("user_id")
  siteId     String          @map("site_id")
  trainedAt  DateTime        @default(now()) @map("trained_at")
  trainedBy  String?         @map("trained_by")
  validUntil DateTime?       @map("valid_until")
  notes      String?         @db.Text
  status     ClearanceStatus @default(ACTIVE)

  // Einarbeitungs-Details
  trainingCompletedAt DateTime? @map("training_completed_at")
  trainingHours       Int?      @default(0) @map("training_hours")
  approvedBy          String?   @map("approved_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  site     Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  trainer  User? @relation("ClearanceTrainer", fields: [trainedBy], references: [id])
  approver User? @relation("ClearanceApprover", fields: [approvedBy], references: [id])

  @@unique([userId, siteId], name: "object_clearances_user_site_key")
  @@index([userId], name: "object_clearances_user_idx")
  @@index([siteId], name: "object_clearances_site_idx")
  @@index([status], name: "object_clearances_status_idx")
  @@index([validUntil], name: "object_clearances_valid_idx")
  @@map("object_clearances")
}

enum ClearanceStatus {
  ACTIVE
  TRAINING // In Einarbeitung
  EXPIRED
  REVOKED
}

enum SiteStatus {
  INQUIRY // Kundenanfrage
  IN_REVIEW // In Pr√ºfung
  CALCULATING // Kalkulation l√§uft
  OFFER_SENT // Angebot versendet
  ACTIVE // Aktiv betreut
  INACTIVE // Inaktiv (Vertrag beendet)
  LOST // Verloren
}

// ===== SICHERHEITSKONZEPT (Herzst√ºck des Objekt-Managements) =====
// TODO: Create migration for this table before uncommenting

// // model SecurityConcept {
//   id     String @id @default(cuid())
//   siteId String
//   site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
// 
//   // Metadaten & Versionierung
//   version    String                  @default("1.0")
//   status     SecurityConceptStatus   @default(DRAFT)
//   validFrom  DateTime?
//   validUntil DateTime?
// 
//   // 1. Auftragsrahmen & Vertragsdaten
//   contractScope Json? // { auftraggeber, vertragsnummer, laufzeit, leistungsumfang }
// 
//   // 2. Rechtsgrundlagen
//   legalBasis Json? // { ¬ß34a, DSGVO, ArbZG, BetrVG, relevante Verordnungen }
// 
//   // 3. Objekt-/Lagebild
//   siteSituation Json? // { geb√§udetyp, gr√∂√üe, nutzung, zugangswege, umgebungsrisiken }
// 
//   // 4. Risikobeurteilung ‚≠ê KRITISCH
//   // Format: { scenarios: [{ name, wahrscheinlichkeit: 1-5, auswirkung: 1-5, score: 1-25, ma√ünahmen }] }
//   riskAssessment Json? @map("risk_assessment")
// 
//   // 5. Schutz- & Ma√ünahmenplan
//   protectionMeasures Json? @map("protection_measures") // { zugangskontrolle, video√ºberwachung, alarmierung, streifeng√§nge }
// 
//   // 6. Personal & Qualifikationen ‚≠ê‚≠ê‚≠ê KRITISCHSTE KOMPONENTE
//   // Format: { anzahlMA, qualifikationen: ["34a", "Erste Hilfe"], schichtmodell: {...} }
//   staffRequirements Json? @map("staff_requirements")
// 
//   // 7. Schichtmodell (aus staffRequirements extrahiert f√ºr schnellen Zugriff)
//   // Format: { model: "2-SHIFT"|"3-SHIFT"|"ROTATING", hoursPerWeek: 168, shifts: [{ name, start, end, requiredStaff }] }
//   shiftModel Json? @map("shift_model")
// 
//   // 8. Aufgaben-/Postenprofile
//   taskProfiles Json? @map("task_profiles") // [{ position: "Objektleiter", aufgaben: [...], befugnisse: [...] }]
// 
//   // 9. Kommunikation & Eskalation ‚≠ê KRITISCH
//   communicationPlan Json? @map("communication_plan") // { eskalationsstufen: [...], kontakte: [...] }
// 
//   // 10. Notfall & Evakuierung ‚≠ê‚≠ê SEHR KRITISCH
//   emergencyPlan Json? @map("emergency_plan") // { brand, einbruch, evakuierung, sammelpl√§tze, rettungswege }
// 
//   // 11. Datenschutz (DSGVO) - PFLICHT bei Video√ºberwachung
//   dataProtection Json? @map("data_protection") // { video√ºberwachung: true, speicherdauer, zugriffskontrolle, dsb }
// 
//   // 12. Arbeits-/Gesundheitsschutz
//   occupationalSafety Json? @map("occupational_safety") // { psa, gef√§hrdungsbeurteilung, erste-hilfe }
// 
//   // 13. KPIs & Qualit√§tskontrolle
//   qualityMetrics Json? @map("quality_metrics") // { kpis: [...], pr√ºfintervalle, audits }
// 
//   // 14. √úbergaben/Schichtwechsel
//   handoverProcedures Json? @map("handover_procedures") // { ablauf, checklisten, wachbuch }
// 
//   // 15. Anh√§nge & Referenzen
//   attachments Json? // { grundrisse: [...], notfallpl√§ne: [...], dokumentenIDs: [...] }
// 
//   // Optional: Weitere Komponenten
//   trafficConcept   Json? @map("traffic_concept") // Verkehrs-/Parkkonzept
//   weaponConcept    Json? @map("weapon_concept") // Waffenkonzept (falls relevant)
//   weatherProtocols Json? @map("weather_protocols") // Unwetter-Protokolle
// 
//   // Freigabe & G√ºltigkeit
//   approvedBy String? @map("approved_by") // User-ID
//   approvedAt DateTime? @map("approved_at")
// 
//   // Revisions-Historie (JSON: [{ version, date, changes, approver }])
//   revisionHistory Json? @default("[]") @map("revision_history")
// 
//   // Notizen
//   notes String? @db.Text
// 
//   createdAt DateTime @default(now()) @map("created_at")
//   updatedAt DateTime @updatedAt @map("updated_at")
// 
//   @@index([siteId, status], name: "security_concepts_site_status_idx")
//   @@index([status], name: "security_concepts_status_idx")
//   @@index([validUntil], name: "security_concepts_valid_idx")
//   @@map("security_concepts")
// }

// enum SecurityConceptStatus {
//   DRAFT // Entwurf
//   IN_REVIEW // In Pr√ºfung
//   APPROVED // Freigegeben
//   ACTIVE // Aktiv
//   EXPIRED // Abgelaufen
//   ARCHIVED // Archiviert
// }

enum ImageCategory {
  EXTERIOR // Au√üenansicht
  INTERIOR // Innenansicht
  FLOOR_PLAN // Grundriss
  EQUIPMENT // Ausr√ºstung
  EMERGENCY // Notfallplan (visuell)
  OTHER
}

enum SiteRole {
  OBJEKTLEITER // Vollzugriff auf zugewiesenes Objekt
  SCHICHTLEITER // Schicht-Verwaltung, Wachbuch
  MITARBEITER // Lesen, Vorf√§lle melden
}

// Objekt-Bilder
model SiteImage {
  id     String @id @default(cuid())
  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  filename    String
  filePath    String        @map("file_path")
  category    ImageCategory @default(OTHER)
  description String?
  fileSize    Int           @map("file_size")
  mimeType    String        @map("mime_type")

  uploadedAt DateTime @default(now()) @map("uploaded_at")
  uploadedBy String   @map("uploaded_by")
  uploader   User     @relation("SiteImageUploader", fields: [uploadedBy], references: [id])

  @@index([siteId, category])
  @@map("site_images")
}

// Objekt-Zuweisungen (Objektleiter/Schichtleiter)
model SiteAssignment {
  id     String @id @default(cuid())
  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  userId String @map("user_id")
  user   User   @relation("SiteAssignmentUser", fields: [userId], references: [id], onDelete: Cascade)

  role       SiteRole
  assignedAt DateTime @default(now()) @map("assigned_at")
  assignedBy String   @map("assigned_by")

  @@unique([siteId, userId], name: "site_assignments_site_user_key")
  @@index([userId])
  @@index([siteId, role])
  @@map("site_assignments")
}

// Objekt-Dokumente (Dienstanweisungen, Notfallpl√§ne, etc.)
model SiteDocument {
  id     String @id @default(cuid())
  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Dokument-Metadaten
  title       String
  description String?              @db.Text
  category    SiteDocumentCategory

  // File-Informationen
  filename String
  filePath String @map("file_path")
  mimeType String @map("mime_type")
  fileSize Int    @map("file_size")

  // Versionierung
  version           Int            @default(1)
  isLatest          Boolean        @default(true) @map("is_latest")
  previousVersionId String?        @map("previous_version_id")
  previousVersion   SiteDocument?  @relation("DocumentVersions", fields: [previousVersionId], references: [id], onDelete: SetNull)
  nextVersions      SiteDocument[] @relation("DocumentVersions")

  // Metadaten
  uploadedAt DateTime @default(now()) @map("uploaded_at")
  uploadedBy String   @map("uploaded_by")
  uploader   User     @relation("SiteDocumentUploader", fields: [uploadedBy], references: [id])
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([siteId, category])
  @@index([siteId, isLatest])
  @@map("site_documents")
}

enum SiteDocumentCategory {
  DIENSTANWEISUNG // Dienstanweisungen
  NOTFALLPLAN // Notfallpl√§ne
  VERTRAG // Vertr√§ge mit Kunde
  BRANDSCHUTZORDNUNG // Brandschutzordnung
  HAUSORDNUNG // Hausordnung
  GRUNDRISS // Geb√§udepl√§ne (erg√§nzend zu Images)
  SONSTIGES // Sonstiges
}

// Objekt-Vorf√§lle / Wachbuch-Eintr√§ge
model SiteIncident {
  id     String @id @default(cuid())
  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Schicht-Kontext (optional - wenn Vorfall w√§hrend einer Schicht passierte)
  shiftId String? @map("shift_id")
  shift   Shift?  @relation("SiteIncidentShift", fields: [shiftId], references: [id], onDelete: SetNull)

  // Vorfall-Informationen
  title       String
  description String?              @db.Text
  category    SiteIncidentCategory
  severity    IncidentSeverity

  // Zeit & Ort
  occurredAt DateTime // Wann ist es passiert?
  reportedAt DateTime @default(now()) @map("reported_at") // Wann wurde es gemeldet?
  location   String? // Genauer Ort im Objekt

  // Personen
  reportedBy      String  @map("reported_by")
  reporter        User    @relation("SiteIncidentReporter", fields: [reportedBy], references: [id])
  involvedPersons String? @db.Text // JSON-Array mit Namen/Details

  // Status & Follow-up
  status     IncidentStatus @default(OPEN)
  resolvedAt DateTime?      @map("resolved_at")
  resolution String?        @db.Text

  // Metadaten
  notificationsEnabled Boolean  @default(true) @map("notifications_enabled")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  history IncidentHistory[]

  @@index([siteId, occurredAt])
  @@index([siteId, status])
  @@index([siteId, category])
  @@map("site_incidents")
}

// √Ñnderungs-Historie f√ºr Site Incidents (Audit Trail)
model IncidentHistory {
  id         String   @id @default(cuid())
  incidentId String   @map("incident_id")
  incident   SiteIncident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  // Wer hat die √Ñnderung gemacht?
  userId String @map("user_id")
  user   User   @relation("IncidentHistoryUser", fields: [userId], references: [id])

  // Was wurde gemacht?
  action IncidentHistoryAction

  // Detaillierte √Ñnderungen (JSON)
  // Format: {"field": {"old": "...", "new": "..."}}
  // Beispiel: {"status": {"old": "OPEN", "new": "IN_PROGRESS"}, "title": {"old": "...", "new": "..."}}
  changes String? @db.Text

  // Zus√§tzliche Notiz (optional)
  note String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([incidentId, createdAt])
  @@map("incident_history")
}

enum SiteIncidentCategory {
  FIRE // Brand
  BREAK_IN // Einbruch
  THEFT // Diebstahl
  VANDALISM // Vandalismus
  ACCIDENT // Unfall
  MEDICAL_EMERGENCY // Medizinischer Notfall
  DISTURBANCE // Ruhest√∂rung
  PROPERTY_DAMAGE // Sachschaden
  SUSPICIOUS_PERSON // Verd√§chtige Person
  TECHNICAL_FAILURE // Technischer Ausfall
  OTHER // Sonstiges
}

enum IncidentHistoryAction {
  CREATED // Vorfall wurde erstellt
  UPDATED // Vorfall wurde bearbeitet
  RESOLVED // Vorfall wurde aufgel√∂st
  STATUS_CHANGED // Status wurde ge√§ndert
  DELETED // Vorfall wurde gel√∂scht (wird nicht mehr verwendet bei Cascade)
}

// Eins√§tze / Events
model Event {
  id                  String      @id @default(cuid())
  title               String
  description         String?
  siteId              String?
  site                Site?       @relation(fields: [siteId], references: [id])
  startTime           DateTime
  endTime             DateTime
  serviceInstructions String
  assignedEmployeeIds String[]
  status              EventStatus @default(PLANNED)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([startTime], name: "events_start_idx")
  @@index([siteId, startTime], name: "events_site_start_idx")
  @@map("events")
}

enum EventStatus {
  PLANNED
  ACTIVE
  DONE
  CANCELLED
}

// Push-Ger√§te-Token
enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

model DeviceToken {
  id                   String         @id @default(cuid())
  userId               String
  user                 User           @relation(fields: [userId], references: [id])
  platform             DevicePlatform
  token                String         @unique
  isActive             Boolean        @default(true)
  notificationsEnabled Boolean        @default(true)
  lastUsedAt           DateTime?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@index([userId], name: "device_tokens_user_idx")
  @@map("device_tokens")
}

model AuditLog {
  id           String   @id @default(cuid())
  occurredAt   DateTime @default(now())
  actorId      String?
  actorRole    String?
  actorIp      String?
  action       String
  resourceType String
  resourceId   String?
  data         Json?
  requestId    String?
  userAgent    String?
  outcome      String?

  @@index([occurredAt], name: "audit_logs_occurredAt_idx")
  @@index([resourceType, resourceId], name: "audit_logs_resource_idx")
  @@index([actorId, occurredAt], name: "audit_logs_actor_idx")
  @@map("audit_logs")
}

// ===== PHASE 4: KONTROLLG√ÑNGE & NFC-RUNDENWESEN =====

// Kontrollpunkt (physischer Punkt am Objekt mit NFC-Tag oder QR-Code)
model ControlPoint {
  id           String  @id @default(cuid())
  siteId       String
  site         Site    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  name         String // z.B. "Haupteingang Nord"
  location     String // Beschreibung, z.B. "Erdgeschoss, linker Eingang"
  instructions String? @db.Text // Was ist zu pr√ºfen? (optional)

  // NFC oder QR
  nfcTagId String? @unique // NFC-Tag-UID (z.B. "04:5E:3A:2B:1C:80")
  qrCode   String? @unique // QR-Code-Inhalt (z.B. "CP-site123-point456-secret")

  // Position & Reihenfolge
  order     Int    @default(0) // Reihenfolge im Kontrollgang
  latitude  Float? // GPS-Koordinaten (optional, f√ºr Verifikation)
  longitude Float?

  // Status
  isActive Boolean @default(true)

  // Relationen
  scans ControlScan[] // Alle Scans dieses Punktes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId, order], name: "control_points_site_order_idx")
  @@index([siteId, isActive], name: "control_points_site_active_idx")
  @@map("control_points")
}

// Kontrollgang (eine Runde, die ein MA durchf√ºhrt)
model ControlRound {
  id          String  @id @default(cuid())
  siteId      String
  site        Site    @relation(fields: [siteId], references: [id], onDelete: Cascade)
  shiftId     String?
  shift       Shift?  @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  performedBy String // User-ID des MA
  performer   User    @relation("ControlRoundPerformer", fields: [performedBy], references: [id])

  // Zeitstempel
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Status
  status ControlRoundStatus @default(IN_PROGRESS)

  // Statistiken
  totalPoints   Int @default(0) // Anzahl zu scannender Punkte
  scannedPoints Int @default(0) // Anzahl gescannter Punkte
  missedPoints  Int @default(0) // Anzahl √ºbersprungener Punkte

  // Notizen
  notes String? @db.Text // Besondere Vorkommnisse

  // Relationen
  scans ControlScan[] // Alle Scans in dieser Runde

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId, startedAt], name: "control_rounds_site_start_idx")
  @@index([performedBy, status], name: "control_rounds_performer_status_idx")
  @@index([shiftId], name: "control_rounds_shift_idx")
  @@map("control_rounds")
}

enum ControlRoundStatus {
  IN_PROGRESS // L√§uft gerade
  COMPLETED // Abgeschlossen
  INCOMPLETE // Abgebrochen (nicht alle Punkte)
  CANCELLED // Storniert
}

// Scan-Event (ein einzelner Scan eines Kontrollpunktes)
model ControlScan {
  id        String       @id @default(cuid())
  roundId   String
  round     ControlRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  pointId   String
  point     ControlPoint @relation(fields: [pointId], references: [id])
  scannedBy String // User-ID
  scanner   User         @relation("ControlScanScanner", fields: [scannedBy], references: [id])
  scannedAt DateTime     @default(now())

  // Scan-Details
  scanMethod    ScanMethod // NFC oder QR
  tagIdentifier String // Die gescannte Tag-ID oder QR-Code

  // GPS-Position (optional, f√ºr Verifikation)
  latitude  Float?
  longitude Float?
  accuracy  Float? // GPS-Genauigkeit in Metern

  // Notizen
  notes    String? @db.Text // z.B. "Fenster stand offen"
  hasIssue Boolean @default(false) // Auff√§lligkeit?

  // Verifikation
  isValid         Boolean @default(true) // Scan g√ºltig?
  validationError String? // Fehlermeldung bei ung√ºltigem Scan

  @@index([roundId, scannedAt], name: "control_scans_round_time_idx")
  @@index([pointId, scannedAt], name: "control_scans_point_time_idx")
  @@index([scannedBy], name: "control_scans_scanner_idx")
  @@map("control_scans")
}

enum ScanMethod {
  NFC // NFC-Tag gescannt
  QR_CODE // QR-Code gescannt
  MANUAL // Manuell eingetragen (Notfall)
}

// ========== PHASE 5: KALKULATION & ANGEBOTSERSTELLUNG ==========

// Preismodell-Template (wiederverwendbar f√ºr verschiedene Objekttypen)
model PriceModel {
  id          String  @id @default(cuid())
  name        String // z.B. "Standard Objektschutz 2025"
  description String? @db.Text
  isActive    Boolean @default(true)

  // Basis-Stundens√§tze (brutto pro Stunde)
  hourlyRateEmployee     Float @default(13.50) // Mitarbeiter
  hourlyRateShiftLeader  Float @default(16.00) // Schichtleiter
  hourlyRateSiteManager  Float @default(18.50) // Objektleiter

  // Zeitzuschl√§ge (Prozent)
  nightSurcharge    Float @default(25) // Nachtarbeit 22-6 Uhr
  saturdaySurcharge Float @default(25) // Samstag
  sundaySurcharge   Float @default(50) // Sonntag
  holidaySurcharge  Float @default(100) // Feiertag

  // Qualifikationszuschl√§ge (‚Ç¨/h)
  nslCertificateSurcharge Float @default(1.50) // 34a-Schein
  dogHandlerSurcharge     Float @default(2.50) // Hundf√ºhrer
  weaponLicenseSurcharge  Float @default(2.00) // Waffensachkunde

  // Gemeinkosten & Marge (Prozent)
  overheadPercentage    Float @default(12) // Gemeinkosten
  profitMarginPercentage Float @default(15) // Gewinnmarge

  // Beziehungen
  calculations SiteCalculation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("price_models")
}

// Objekt-Kalkulation (konkrete Berechnung f√ºr ein Objekt)
model SiteCalculation {
  id           String            @id @default(cuid())
  siteId       String
  priceModelId String? // Optional: basiert auf Template
  version      Int               @default(1) // Versionsnummer
  status       CalculationStatus @default(DRAFT)

  // Objekt-Anforderungen
  requiredStaff           Int   @default(1) // Anzahl MA
  hoursPerWeek            Float @default(40) // Std. pro Woche
  contractDurationMonths  Int   @default(12) // Vertragslaufzeit

  // Zeitverteilung (Std. pro Woche)
  hoursDay      Float @default(40) // Tagschicht
  hoursNight    Float @default(0) // Nachtschicht
  hoursSaturday Float @default(0)
  hoursSunday   Float @default(0)
  hoursHoliday  Float @default(0) // Feiertage (gesch√§tzt)

  // Personalstruktur
  employeeCount     Int @default(1) // Anzahl Mitarbeiter
  shiftLeaderCount  Int @default(0) // Anzahl Schichtleiter
  siteManagerCount  Int @default(0) // Anzahl Objektleiter

  // Custom Stundens√§tze (√ºberschreiben PriceModel)
  customHourlyRateEmployee    Float? // Falls abweichend
  customHourlyRateShiftLeader Float?
  customHourlyRateSiteManager Float?

  // Custom Zeitzuschl√§ge (√ºberschreiben PriceModel)
  customNightSurcharge    Float?
  customSaturdaySurcharge Float?
  customSundaySurcharge   Float?
  customHolidaySurcharge  Float?

  // Zuschl√§ge & Sonderkonditionen
  riskSurchargePercentage Float @default(0) // Risikozuschlag %
  distanceSurcharge       Float @default(0) // ‚Ç¨/h (Entfernung)

  // Custom Gemeinkosten & Marge (√ºberschreiben PriceModel)
  customOverheadPercentage     Float? // Gemeinkosten %
  customProfitMarginPercentage Float? // Gewinnmarge %

  // Berechnete Kosten (automatisch)
  totalPersonnelCostMonthly Float @default(0) // Personal
  totalOverheadMonthly      Float @default(0) // Gemeinkosten
  totalProfitMonthly        Float @default(0) // Gewinn
  totalPriceMonthly         Float @default(0) // Gesamt (netto)

  // Einmalige Kosten
  setupCostUniform   Float @default(0)
  setupCostEquipment Float @default(0)
  setupCostOther     Float @default(0)

  // Notizen & Anmerkungen
  notes String? @db.Text

  // Meta
  calculatedBy String // User-ID
  calculatedAt DateTime @default(now())
  sentAt       DateTime? // Status ‚Üí SENT
  acceptedAt   DateTime? // Status ‚Üí ACCEPTED
  rejectedAt   DateTime? // Status ‚Üí REJECTED

  // Beziehungen
  site       Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  priceModel PriceModel? @relation(fields: [priceModelId], references: [id], onDelete: SetNull)
  calculator User       @relation("CalculationCalculator", fields: [calculatedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([siteId, version], name: "site_calculation_version_idx")
  @@index([status], name: "site_calculation_status_idx")
  @@map("site_calculations")
}

enum CalculationStatus {
  DRAFT // Entwurf
  SENT // Angebot versendet
  ACCEPTED // Angebot angenommen
  REJECTED // Angebot abgelehnt
  ARCHIVED // Archiviert
}
