generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Benutzer/Mitarbeiter
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  
  // Arbeitsbezogene Informationen
  employeeId     String?  @unique
  hireDate       DateTime?
  qualifications String[] // Array von Qualifikationen
  pushOptIn      Boolean  @default(true)
  emailOptIn     Boolean  @default(true)
  
  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Beziehungen
  shifts        ShiftAssignment[]
  timeEntries   TimeEntry[]
  incidents     Incident[]
  profile       EmployeeProfile?
  absencesRequested Absence[]        @relation("AbsenceUser")
  absencesCreated   Absence[]        @relation("AbsenceCreatedBy")
  absencesDecided   Absence[]        @relation("AbsenceDecidedBy")
  documentsUploaded EmployeeDocument[] @relation("EmployeeDocumentUploadedBy")

  @@map("users")
  @@index([lastName, firstName], name: "users_name_idx")
  @@index([createdAt], name: "users_createdAt_idx")
  @@index([isActive], name: "users_isActive_idx")
  @@index([role], name: "users_role_idx")
  deviceTokens DeviceToken[]
}

// Einsatzorte/Sites
model Site {
  id         String   @id @default(cuid())
  name       String
  address    String
  city       String
  postalCode String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Beziehungen
  shifts     Shift[]
  events     Event[]

  @@unique([name, address], name: "sites_name_address_key")
  @@map("sites")
  @@index([name], name: "sites_name_idx")
  @@index([city], name: "sites_city_idx")
  @@index([postalCode], name: "sites_postal_idx")
}

// Benutzerrollen
enum UserRole {
  ADMIN
  MANAGER
  DISPATCHER
  EMPLOYEE
}

// Schichten/Dienste
model Shift {
  id          String    @id @default(cuid())
  siteId      String?
  site        Site?     @relation(fields: [siteId], references: [id])
  title       String
  description String?
  location    String
  startTime   DateTime
  endTime     DateTime
  
  // Anforderungen
  requiredEmployees Int      @default(1)
  requiredQualifications String[]
  
  // Status
  status      ShiftStatus @default(PLANNED)
  
  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Beziehungen
  assignments ShiftAssignment[]
  timeEntries TimeEntry[]

  @@map("shifts")
  @@index([startTime], name: "shifts_startTime_idx")
  @@index([status], name: "shifts_status_idx")
  @@index([siteId, startTime], name: "shifts_site_start_idx")
}

enum ShiftStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

// Zuweisungen von Mitarbeitern zu Schichten
model ShiftAssignment {
  id     String @id @default(cuid())
  
  // Beziehungen
  userId  String
  shiftId String
  user    User   @relation(fields: [userId], references: [id])
  shift   Shift  @relation(fields: [shiftId], references: [id])
  
  // Status
  status AssignmentStatus @default(ASSIGNED)
  
  // Zeitstempel
  assignedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([userId, shiftId])
  @@map("shift_assignments")
  @@index([shiftId], name: "shift_assignments_shift_idx")
}

enum AssignmentStatus {
  ASSIGNED
  CONFIRMED
  STARTED
  COMPLETED
  CANCELLED
}

// Zeiterfassung
model TimeEntry {
  id String @id @default(cuid())
  
  // Beziehung
  userId String
  user   User   @relation(fields: [userId], references: [id])
  shiftId String?
  shift   Shift?  @relation(fields: [shiftId], references: [id])
  
  // Zeitdaten
  startTime DateTime
  endTime   DateTime?
  breakTime Int?      // Pause in Minuten
  
  // Location (Optional f체r GPS)
  startLocation String?
  endLocation   String?
  
  // Notizen
  notes String?
  
  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("time_entries")
  @@index([userId, startTime], name: "time_entries_user_start_idx")
}

// Vorf채lle
model Incident {
  id          String   @id @default(cuid())
  title       String
  description String
  severity    IncidentSeverity
  status      IncidentStatus @default(OPEN)
  
  // Ort und Zeit
  location  String
  occurredAt DateTime
  
  // Beziehung
  reportedBy String
  user       User   @relation(fields: [reportedBy], references: [id])
  
  // Zeitstempel
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("incidents")
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model EmployeeProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  address          Json?
  birthDate        DateTime?
  phone            String?
  employmentType   EmploymentType @default(FULL_TIME)
  employmentStart  DateTime?
  employmentEnd    DateTime?
  workSchedule     String?
  hourlyRate       Decimal? @db.Decimal(10, 2)
  weeklyTargetHours Int?
  monthlyTargetHours Int?
  notes            String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User     @relation(fields: [userId], references: [id])
  qualifications   EmployeeQualification[]
  documents        EmployeeDocument[]

  @@map("employee_profiles")
}

model EmployeeQualification {
  id          String   @id @default(cuid())
  profileId   String
  title       String
  description String?
  validFrom   DateTime?
  validUntil  DateTime?

  profile     EmployeeProfile @relation(fields: [profileId], references: [id])

  @@map("employee_qualifications")
  @@index([profileId, validUntil], name: "employee_qualifications_profile_valid_idx")
}

model EmployeeDocument {
  id          String   @id @default(cuid())
  profileId   String
  category    DocumentCategory
  filename    String
  mimeType    String
  size        Int
  storedAt    String
  issuedAt    DateTime?
  expiresAt   DateTime?
  uploadedBy  String
  createdAt   DateTime @default(now())

  profile     EmployeeProfile @relation(fields: [profileId], references: [id])
  uploader    User            @relation("EmployeeDocumentUploadedBy", fields: [uploadedBy], references: [id])

  @@map("employee_documents")
  @@index([profileId], name: "employee_documents_profile_idx")
  @@index([category], name: "employee_documents_category_idx")
  @@index([expiresAt], name: "employee_documents_expires_idx")
}

model Absence {
  id           String         @id @default(cuid())
  userId       String
  createdById  String
  decidedById  String?
  type         AbsenceType
  status       AbsenceStatus  @default(REQUESTED)
  startsAt     DateTime
  endsAt       DateTime
  reason       String?        @db.Text
  decisionNote String?        @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user        User @relation("AbsenceUser", fields: [userId], references: [id])
  createdBy   User @relation("AbsenceCreatedBy", fields: [createdById], references: [id])
  decidedBy   User? @relation("AbsenceDecidedBy", fields: [decidedById], references: [id])

  @@map("absences")
  @@index([status], name: "absences_status_idx")
  @@index([type], name: "absences_type_idx")
  @@index([startsAt], name: "absences_start_idx")
  @@index([userId, startsAt], name: "absences_user_start_idx")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  MINI_JOB
  TEMPORARY
  CONTRACTOR
}

enum DocumentCategory {
  FIREARM_LICENSE
  WARNING_LETTER
  CONTRACT
  TRAINING_CERTIFICATE
  MEDICAL_CERTIFICATE
  OTHER
}

enum AbsenceType {
  VACATION
  SICKNESS
  SPECIAL_LEAVE
  UNPAID
}

enum AbsenceStatus {
  REQUESTED
  APPROVED
  REJECTED
  CANCELLED
}

// Eins채tze / Events
model Event {
  id                  String   @id @default(cuid())
  title               String
  description         String?
  siteId              String?
  site                Site?    @relation(fields: [siteId], references: [id])
  startTime           DateTime
  endTime             DateTime
  serviceInstructions String
  assignedEmployeeIds String[]
  status              EventStatus @default(PLANNED)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("events")
  @@index([startTime], name: "events_start_idx")
  @@index([siteId, startTime], name: "events_site_start_idx")
}

enum EventStatus {
  PLANNED
  ACTIVE
  DONE
  CANCELLED
}

// Push-Ger채te-Token
enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

model DeviceToken {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  platform    DevicePlatform
  token       String         @unique
  isActive    Boolean        @default(true)
  notificationsEnabled Boolean @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("device_tokens")
  @@index([userId], name: "device_tokens_user_idx")
}

model AuditLog {
  id           String   @id @default(cuid())
  occurredAt   DateTime @default(now())
  actorId      String?
  actorRole    String?
  actorIp      String?
  action       String
  resourceType String
  resourceId   String?
  data         Json?
  requestId    String?
  userAgent    String?
  outcome      String?

  @@map("audit_logs")
  @@index([occurredAt], name: "audit_logs_occurredAt_idx")
  @@index([resourceType, resourceId], name: "audit_logs_resource_idx")
  @@index([actorId, occurredAt], name: "audit_logs_actor_idx")
}
