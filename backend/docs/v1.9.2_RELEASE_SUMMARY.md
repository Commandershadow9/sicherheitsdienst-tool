# Release v1.9.2 - Stability & Bugfix Release

**Release-Datum:** 07.10.2025
**Typ:** Bugfix Release
**Status:** ‚úÖ Released & Deployed
**Git Commit:** 6629531

---

## Zusammenfassung

Version 1.9.2 ist ein **Stability & Bugfix Release**, das 5 kritische Bugs aus dem Testing von v1.9.1 behebt. Der Fokus liegt auf:

- ‚úÖ Live Score-Berechnung im Intelligent Replacement System
- ‚úÖ Korrekte Urlaubstage-Berechnung
- ‚úÖ Kompakte Schichten-√úbersicht
- ‚úÖ Automatisches Dashboard-Refresh
- ‚úÖ Korrekte Abwesenheiten-Filter bei Ersatzsuche

---

## Behobene Bugs

### BUG-001 [HIGH]: Score-Berechnung nicht live/interaktiv ‚úÖ

**Problem:**
- Scores wurden aus gecachter `employee_workloads`-Tabelle berechnet
- Neue Schicht-Zuweisungen wurden nicht sofort ber√ºcksichtigt
- Workload-Zahlen waren veraltet

**L√∂sung:**
- `calculateLiveWorkload()` in `intelligentReplacementService.ts`
- Real-time Query auf `ShiftAssignment` statt Cache
- ISO-Wochen-Berechnung f√ºr w√∂chentliche Arbeitsstunden (ArbZG)

**Betroffene Dateien:**
- `backend/src/services/intelligentReplacementService.ts` (+79 Zeilen)

---

### BUG-002 [MEDIUM]: Urlaubsanspruch falsch berechnet ‚úÖ

**Problem:**
- Verf√ºgbare Urlaubstage = Jahresanspruch - Genommene - **Beantragte** ‚ùå
- Falsch! Beantragte sind noch nicht genehmigt

**L√∂sung:**
- Verf√ºgbare = Jahresanspruch - Genommene ‚úÖ
- "Nach Genehmigung verbleibend" als separate Anzeige
- Warnung wenn Antrag Urlaubstage √ºberschreitet

**Betroffene Dateien:**
- `backend/src/controllers/absenceController.ts` (Export calculateLeaveDaysSaldo)
- `backend/src/controllers/dashboardController.ts` (+15 Zeilen)
- `frontend/src/features/dashboard/QuickApprovalModal.tsx` (+40 Zeilen)
- `frontend/src/features/dashboard/types.ts` (+7 Zeilen)

---

### BUG-003 [LOW]: Schichtenliste zu lang und nicht informativ ‚úÖ

**Problem:**
- Alle Schichten einzeln aufgelistet
- Un√ºbersichtlich bei vielen Schichten
- Keine Zusammenfassung

**L√∂sung:**
- **Kompakte √úbersicht** oben:
  - Anzahl Schichten
  - Zeitraum (von-bis)
  - Anzahl unterbesetzt
- Details darunter ausklappbar

**Betroffene Dateien:**
- `frontend/src/features/absences/AbsenceDetailModal.tsx` (+28 Zeilen)

---

### BUG-004 [MEDIUM]: Dashboard aktualisiert nicht automatisch ‚úÖ

**Problem:**
- Nach Ersatz-Zuweisung blieb Dashboard veraltet
- User musste manuell neu laden
- "Kritische Schichten (1)" trotz Zuweisung

**L√∂sung:**
- React Query Cache Invalidation in `useAbsenceDetail`
- Invalidierung beim Modal schlie√üen
- Erfolgs-Toast "Dashboard wird aktualisiert"

**Betroffene Dateien:**
- `frontend/src/features/dashboard/hooks/useAbsenceDetail.ts` (+5 Zeilen)
- `frontend/src/features/absences/AbsenceDetailModal.tsx` (+10 Zeilen)

---

### BUG-005 [CRITICAL]: Abwesenheiten nicht korrekt gefiltert ‚úÖ

**Problem:**
- APPROVED + REQUESTED Absences wurden gleich behandelt
- Beide schlossen Kandidaten aus
- Aber: REQUESTED ist noch nicht genehmigt!

**L√∂sung:**
- **Separate Queries:**
  - APPROVED: Kandidat ausschlie√üen ‚ùå
  - REQUESTED: Kandidat zeigen mit Warnung ‚ö†Ô∏è
- Warnung: "‚ö†Ô∏è Urlaub beantragt: 08.10. - 12.10."

**Betroffene Dateien:**
- `backend/src/services/replacementService.ts` (+91 Zeilen, umfangreiches Refactoring)

---

## Zus√§tzliche Verbesserungen

### Dashboard v2 API Integration

**Kritische Schichten** nutzen jetzt v2 API mit intelligentem Scoring:

- ‚úÖ REST-compliant Route: `/api/shifts/:id/replacement-candidates/v2`
- ‚úÖ Legacy-Support: `/api/shifts/:id/replacement-candidates-v2` (Redirect)
- ‚úÖ Score-basierte Sortierung (OPTIMAL ‚Üí NOT_RECOMMENDED)
- ‚úÖ Workload, Compliance, Fairness, Preference

**Betroffene Dateien:**
- `backend/src/routes/shiftRoutes.ts` (+15 Zeilen)
- `frontend/src/features/dashboard/hooks/useReplacementModal.ts` (v2 API)
- `frontend/src/features/dashboard/api.ts` (+7 Zeilen)
- `frontend/src/pages/Dashboard.tsx` (v2 Modal)

---

### Urlaubstage-Saldo in Genehmigungen

**Pending Approvals** zeigen jetzt Urlaubstage-Saldo an:

```
Urlaubstage-Saldo:
  Jahresanspruch:       30 Tage
  Bereits genommen:     15 Tage
  Beantragt (gesamt):   20 Tage
  Aktuell verf√ºgbar:    15 Tage
  Nach Genehmigung:     10 Tage
```

Mit Warnung wenn √ºberschritten: ‚ö†Ô∏è

**Betroffene Dateien:**
- `backend/src/controllers/dashboardController.ts`
- `frontend/src/features/dashboard/QuickApprovalModal.tsx`

---

## Test-Szenarien v1.9.2

Neue umfangreiche Test-Daten in `seedTestScenarios.ts`:

### Test-Daten

**Benutzer:** 12 (1 Admin, 1 Manager, 10 Employees)

**Login-Daten:**
```
Admin:    admin@sicherheitsdienst.de / password123
Manager:  manager@sicherheitsdienst.de / password123
Employee: thomas.mueller@sec.de / password123 (+ 9 weitere)
```

**Sites:** 2
- B√ºrogeb√§ude Zentrum
- Einkaufszentrum Nord

**Schichten:** 4
- **Heute 08:00-16:00:** Tagschicht B√ºrogeb√§ude (KRITISCH - 1 fehlt)
- **Heute 18:00-02:00:** Nachtschicht Einkaufszentrum (OK)
- Morgen 08:00-16:00
- In 3 Tagen (Petra beantragt Urlaub daf√ºr)

**Abwesenheiten:** 4
- 1 APPROVED (Michael Wagner krank ‚Üí macht Schicht kritisch)
- 3 REQUESTED:
  - Julia Becker: 5 Tage Urlaub ‚úÖ (genug Urlaubstage)
  - Stefan Fischer: 10 Tage Urlaub ‚ö†Ô∏è (√ºberschreitet Urlaubstage)
  - Petra Hoffmann: 3 Tage Urlaub üîç (betrifft Schicht)

### Test-Flows

1. **Dashboard ‚Üí Heute kritisch (1) ‚Üí Ersatz suchen**
   - Erwarte: Kandidaten mit Scores (OPTIMAL/GOOD/ACCEPTABLE/NOT_RECOMMENDED)
   - ‚úÖ V2 API mit intelligentem Scoring

2. **Dashboard ‚Üí Ausstehende Genehmigungen (3) ‚Üí Antrag ausw√§hlen**
   - Erwarte: Urlaubstage-Saldo mit Warnung bei √úberschreitung
   - ‚úÖ Stefan Fischer √ºberschreitet Urlaubstage

3. **Dashboard ‚Üí Details ‚Üí Ersatz zuweisen ‚Üí Modal schlie√üen**
   - Erwarte: Dashboard aktualisiert automatisch
   - ‚úÖ Query Invalidation funktioniert

### Seed ausf√ºhren

```bash
cd backend
DATABASE_URL="postgresql://admin:admin123@localhost:5432/sicherheitsdienst_db?schema=public" \
npx ts-node src/utils/seedTestScenarios.ts
```

---

## Deployment Notes

### ‚ö†Ô∏è WICHTIG: Docker Build Cache Problem

**Problem:**
- TypeScript-√Ñnderungen wurden **nicht** in Container √ºbernommen
- `docker compose build api` nutzte gecachte Dateien
- Trat bereits **2x** auf!

**L√∂sung f√ºr Deployment:**

```bash
# Option A: Clean Build (EMPFOHLEN f√ºr Code-√Ñnderungen)
cd /home/cmdshadow/project
docker compose build --no-cache api
docker restart sicherheitsdienst-api

# Option B: Manuell kompilieren + kopieren
cd backend
rm -rf dist
npx tsc -p tsconfig.json
docker cp dist/. sicherheitsdienst-api:/app/dist/
docker restart sicherheitsdienst-api
```

**Verification nach Deployment:**

```bash
# 1. Route existiert?
docker exec sicherheitsdienst-api cat /app/dist/routes/shiftRoutes.js | grep "replacement-candidates/v2"

# 2. Controller-√Ñnderungen deployed?
docker exec sicherheitsdienst-api cat /app/dist/controllers/dashboardController.js | grep "leaveDaysSaldo"

# 3. API funktioniert?
curl -s http://127.0.0.1:3001/health
```

Siehe: `docs/DEPLOYMENT_ISSUES.md` f√ºr Details

---

### Rate Limiting

Bei vielen Test-Logins kann Rate-Limit greifen:

```bash
# Redis flushen
docker exec sicherheitsdienst-redis redis-cli FLUSHALL
```

**TODO:** Rate-Limits per ENV konfigurierbar machen

---

## Bekannte Probleme & TODOs

### ‚ö†Ô∏è Test-Setup Kl√§rungsbedarf

Es scheint **mehrere Test-Ebenen** mit verschiedenen Login-Daten zu geben:

**Offene Fragen:**
1. Welche Datenbanken gibt es? (Dev/Test/Staging/Prod?)
2. Welche Login-Daten f√ºr welche Umgebung?
3. Welche Seed-Skripte wof√ºr?
   - `seedData.ts` (alt/deprecated?)
   - `seedTestScenarios.ts` (aktuell)
   - `intelligent-replacement-v1.8.0.ts` (noch verwendet?)

**Empfehlung:**
```bash
npm run seed:dev     # Development (umfangreich)
npm run seed:test    # Testing (minimal)
npm run seed:staging # Production-√§hnlich
```

Siehe: `docs/TEST_SETUP.md` f√ºr Details

---

### Technical Debt (v1.10.0)

- [ ] Prisma SSL Warning beheben
- [ ] Rate Limiting per ENV konfigurierbar
- [ ] Seed-Skripte konsolidieren
- [ ] TypeScript Strict Mode
- [ ] Docker Build Cache final l√∂sen
- [ ] CI/CD Pipeline f√ºr Deployments

---

## Statistiken

**Code-√Ñnderungen:**
- 27 Dateien ge√§ndert
- 3.795 Zeilen hinzugef√ºgt
- 202 Zeilen entfernt

**Neue Dateien:**
- 7 Dokumentationsdateien
- 1 Seed-Skript (seedTestScenarios.ts)

**Betroffene Bereiche:**
- Backend: Services, Controllers, Routes
- Frontend: Dashboard, Absences, Hooks
- Docs: Changelog, Roadmap, Deployment, Test-Setup

---

## Migration Guide

**Von v1.9.1 auf v1.9.2:**

Keine Breaking Changes! üéâ

**Deployment:**
```bash
# 1. Code pullen
git pull origin main

# 2. Database Migrations (keine neuen)
DATABASE_URL="..." npx prisma migrate deploy

# 3. Backend bauen (OHNE CACHE!)
docker compose build --no-cache api

# 4. Restart
docker restart sicherheitsdienst-api

# 5. Verify
curl http://127.0.0.1:3001/health
```

**Optional: Test-Daten neu seeden**
```bash
DATABASE_URL="..." npx prisma migrate reset --force
DATABASE_URL="..." npx ts-node src/utils/seedTestScenarios.ts
```

---

## Weitere Dokumentation

- **CHANGELOG:** Vollst√§ndige Release Notes ‚Üí `docs/CHANGELOG.md`
- **ROADMAP:** Zuk√ºnftige Features (v1.10.0+) ‚Üí `docs/ROADMAP.md`
- **DEPLOYMENT_ISSUES:** Docker Cache & Troubleshooting ‚Üí `docs/DEPLOYMENT_ISSUES.md`
- **TEST_SETUP:** Login-Daten & Seed-Skripte ‚Üí `docs/TEST_SETUP.md`
- **BUGS (v1.9.1):** Urspr√ºngliche Bug-Reports ‚Üí `docs/BUGS_v1.9.1.md`
- **TODO (v1.9.2):** Implementation Checklist ‚Üí `docs/TODO_v1.9.2.md`

---

## Kontakt & Feedback

**Issues:** https://github.com/Commandershadow9/sicherheitsdienst-tool/issues
**Version:** v1.9.2
**Release-Datum:** 07.10.2025

---

**Status:** ‚úÖ **RELEASED & DEPLOYED**
