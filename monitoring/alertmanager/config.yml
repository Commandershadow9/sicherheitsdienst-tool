# Alertmanager configuration for the Sicherheitsdienst monitoring stack.
# Environment variables are consumed via the built-in template functions.
# Set ALERTMANAGER_SLACK_WEBHOOK / ALERTMANAGER_SLACK_CHANNEL for Slack
# and ALERTMANAGER_WEBHOOK_URL (/ALERTMANAGER_WEBHOOK_BEARER optional) for webhooks.
global:
  resolve_timeout: 5m

route:
  receiver: slack-notify
  group_by: ['alertname', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h
  routes:
    - matchers:
        - severity="critical"
      receiver: ops-webhook
      continue: true

receivers:
  - name: slack-notify
    slack_configs:
      - api_url: '{{ mustEnv "ALERTMANAGER_SLACK_WEBHOOK" }}'
        channel: '{{ if env "ALERTMANAGER_SLACK_CHANNEL" }}{{ env "ALERTMANAGER_SLACK_CHANNEL" }}{{ else }}#on-call{{ end }}'
        send_resolved: true
        title: '{{ .CommonLabels.alertname }} ({{ if .CommonLabels.severity }}{{ .CommonLabels.severity }}{{ else }}unknown{{ end }})'
        text: |-
          *Service:* {{ if .CommonLabels.service }}{{ .CommonLabels.service }}{{ else }}unbekannt{{ end }}
          *Summary:* {{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}Keine Zusammenfassung hinterlegt.{{ end }}
          *Details:* {{ if .CommonAnnotations.description }}{{ .CommonAnnotations.description }}{{ else }}Keine Beschreibung hinterlegt.{{ end }}
          {{- if .CommonAnnotations.runbook_url }}

          *Runbook:* {{ .CommonAnnotations.runbook_url }}
          {{- end }}
  - name: ops-webhook
    webhook_configs:
      - url: '{{ mustEnv "ALERTMANAGER_WEBHOOK_URL" }}'
        send_resolved: true
{{- if env "ALERTMANAGER_WEBHOOK_BEARER" }}
        http_config:
          authorization:
            type: Bearer
            credentials: '{{ env "ALERTMANAGER_WEBHOOK_BEARER" }}'
{{- end }}
        max_alerts: 0

inhibit_rules:
  - source_matchers: [severity="critical"]
    target_matchers: [severity="warning"]
    equal: ['alertname', 'service']
